# å‡½æ•°å¼ç¼–ç¨‹

> GitHub@[orca-j35](https://github.com/orca-j35)ï¼Œæ‰€æœ‰ç¬”è®°å‡æ‰˜ç®¡äº [python_notes](https://github.com/orca-j35/python_notes) ä»“åº“
>
> å‚è€ƒ:
>
> - [Primer on Python Decorators â€“ Real Python](https://realpython.com/primer-on-python-decorators/)
> - [ç¬¬åå…­ç« ï¼šç±»å’Œå‡½æ•° - Think Python](http://codingpy.com/books/thinkpython2/16-classes-and-functions.html?highlight=%E7%BA%AF%E5%87%BD%E6%95%B0#id6)
>   - [Chapter 16  Classes and functions](http://greenteapress.com/thinkpython2/html/thinkpython2017.html)
>
> æ‰©å±•é˜…è¯»: 
>
> - [å‡½æ•°å¼ç¼–ç¨‹åˆæ¢ - é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2012/04/functional_programming.html)
> - [å‡½æ•°å¼ç¼–ç¨‹ - å»–é›ªå³°](https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014317848428125ae6aa24068b4c50a7e71501ab275d52000)
> - [Functional programming - Wikipedia](https://en.wikipedia.org/wiki/Functional_programming#Python)

æ³¨æ„ï¼Œæ˜¯ â€œå‡½æ•°**å¼**ç¼–ç¨‹â€ï¼Œè€Œé â€œå‡½æ•°ç¼–ç¨‹â€ã€‚

å‡½æ•°å¼ç¼–ç¨‹(*functional* *programming*ï¼Œä¼¼ä¹ä¹Ÿç§°ä½œ *monad*)ï¼Œæ˜¯ä¸€ç§["ç¼–ç¨‹èŒƒå¼"](http://en.wikipedia.org/wiki/Programming_paradigm)(*programming* *paradigm*)ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ç¼–å†™ç¨‹åºçš„æ–¹æ³•è®ºã€‚

å‡½æ•°å¼ç¼–ç¨‹å±äº["ç»“æ„åŒ–ç¼–ç¨‹"](http://en.wikipedia.org/wiki/Structured_programming)çš„ä¸€ç§ï¼Œä¸»è¦æ€æƒ³æ˜¯æŠŠè¿ç®—è¿‡ç¨‹å°½é‡å†™æˆä¸€ç³»åˆ—åµŒå¥—çš„å‡½æ•°è°ƒç”¨ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªæ•°å­¦è¡¨è¾¾å¼ï¼š

```
(1 + 2) * 3 - 4
```

ä¼ ç»Ÿçš„è¿‡ç¨‹å¼ç¼–ç¨‹ï¼Œå¯èƒ½è¿™æ ·å†™ï¼š

```
var a = 1 + 2;
var b = a * 3;
var c = b - 4;
```

å‡½æ•°å¼ç¼–ç¨‹è¦æ±‚ä½¿ç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿ç®—è¿‡ç¨‹[å®šä¹‰](http://lostechies.com/derickbailey/2012/01/24/some-thoughts-on-functional-javascript/)ä¸ºä¸åŒçš„å‡½æ•°ï¼Œç„¶åå†™æˆä¸‹é¢è¿™æ ·ï¼š

```
var result = subtract(multiply(add(1,2), 3), 4);
```

å¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°å¼ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°é«˜é˜¶å‡½æ•°å’Œçº¯å‡½æ•°ä¸¤ä¸ªæ¦‚å¿µï¼Œä¾‹å¦‚ `subtract` å’Œ `multiply` æ—¢æ˜¯é«˜é˜¶å‡½æ•°åˆæ˜¯çº¯å‡½æ•°ã€‚

## 1. é«˜é˜¶å‡½æ•°

> å‚è€ƒ: [Higher-order function â€” wikipedia](https://en.wikipedia.org/wiki/Higher-order_function)
>
> æ‰©å±•é˜…è¯»: ï¹æµç•…çš„ Pythonï¹-> 5.2 é«˜é˜¶å‡½æ•° 

In [mathematics](https://en.wikipedia.org/wiki/Mathematics) and [computer science](https://en.wikipedia.org/wiki/Computer_science), a **higher-order function** is a [function](https://en.wikipedia.org/wiki/Function_(mathematics)) that does at least one of the following:

- takes one or more functions as arguments (i.e. [procedural parameters](https://en.wikipedia.org/wiki/Procedural_parameter)),

  ```python
  # addæ˜¯é«˜é˜¶å‡½æ•°ï¼Œå› ä¸ºå®ƒå°†å‡½æ•°fç”¨ä½œå‚æ•°
  def add(x, y, f):
      return f(x) + f(y)
  add(-5, 6, abs) #> 11
  ```

- returns a function as its result. 

  ```python
  # addæ˜¯é«˜é˜¶å‡½æ•°ï¼Œå› ä¸ºå®ƒå°†å‡½æ•°innerä½œä¸ºè¿”å›å€¼
  def deco(func):
      def inner():
           print('running inner()')
      return inner
  ```

  è¯¦è§ç¬”è®°ï¹é—­åŒ….mdï¹->å‡½æ•°å¯¹è±¡ä½œè¿”å›å€¼

All other functions are *first-order functions*. 

higher-order function syntax -- Pythonï¼š

```python
>>> def twice(f): # é«˜é˜¶å‡½æ•°twiceä»¥å‡½æ•°ä½œä¸ºå‚æ•°
...   def result(a):
...     return f(f(a)) # 
...   return result

>>> plusthree = lambda x: x+3

>>> g = twice(plusthree)
    
>>> g(7)
13
```

Python ä¸­çš„å‡½æ•°éƒ½æ˜¯ç¬¬ä¸€ç±»çš„æ•°æ®å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥å°†å‡½æ•°èµ‹å€¼ç»™å˜é‡ã€ä¿å­˜åˆ°æ•°æ®ç»“æ„ä¸­ã€ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶å®ƒå‡½æ•°ï¼Œä»¥åŠä½œä¸ºå…¶å®ƒå‡½æ•°çš„è¿”å›å€¼ã€‚

å†…å»ºé«˜é˜¶å‡½æ•°æœ‰  `map` , `filter` å’Œ `sorted` ï¼›é—­åŒ…(ä»¥å‡½æ•°ä½œä¸ºè¿”å›å€¼)å’Œè£…é¥°å™¨éƒ½è¿ç”¨äº†é«˜é˜¶å‡½æ•°ã€‚

## 2. ä¸€ç±»å¯¹è±¡

åœ¨ Python ä¸­ï¼Œå‡½æ•°æ˜¯ä¸€ç±»æ•°æ®å¯¹è±¡([*first*-class *objects*](https://dbader.org/blog/python-first-class-functions))ï¼Œè¿™æ„å‘³ç€å‡½æ•°å¯ä»¥è¢«ç”¨ä½œå‚æ•°æˆ–è¿”å›å€¼ã€‚

ç¤ºä¾‹ - å°†å‡½æ•°å¯¹è±¡ç”¨ä½œå‚æ•°

```python
def say_hello(name):
    return f"Hello {name}"

def be_awesome(name):
    return f"Yo {name}, together we are the awesomest!"

def greet_bob(greeter_func): # å°†å‡½æ•°ç”¨ä½œå‚æ•°
    return greeter_func("Bob")
'''
>>> greet_bob(say_hello)
'Hello Bob'

>>> greet_bob(be_awesome)
'Yo Bob, together we are the awesomest!'
'''
```

ç¤ºä¾‹ - å°†å‡½æ•°å¯¹è±¡ç”¨ä½œè¿”å›å€¼

```python
def parent(num):
    def first_child():
        return "Hi, I am Emma"

    def second_child():
        return "Call me Liam"

    if num == 1:
        return first_child
    else:
        return second_child
'''
>>> first = parent(1)
>>> second = parent(2)

>>> first
<function parent.<locals>.first_child at 0x7f599f1e2e18>
>>> first()
'Hi, I am Emma'

>>> second
<function parent.<locals>.second_child at 0x7f599dad5268>
>>> second()
'Call me Liam'
'''
```

## 3. ä¿®æ”¹å™¨

ä¿®æ”¹å™¨(*modifier*)æ˜¯æŒ‡ä¼šä¿®æ”¹å…¶æ¥æ”¶åˆ°çš„å®å‚å¯¹è±¡çš„å‡½æ•°ï¼Œå¤§éƒ¨åˆ†ä¿®æ”¹å™¨æ²¡æœ‰è¿”å›å€¼(è¿”å› `None`)ã€‚ä¾‹å¦‚ï¼š

```python
def add(s1,s2):
    s1 += s2
a,b=[1,2,3],[4,5,6]
add(a,b)
a #> [1, 2, 3, 4, 5, 6]
```

## 4. çº¯å‡½æ•°

çº¯å‡½æ•°(*pure* *function*)æ˜¯æŒ‡ä¸ä¼šä¿®æ”¹å…¶æ¥æ”¶åˆ°çš„å®å‚å¯¹è±¡çš„å‡½æ•°ï¼Œå¹¶ä¸”å¤§å¤šæ•°çº¯å‡½æ•°æœ‰è¿”å›å€¼ã€‚ä¾‹å¦‚ï¼š

```python
def add(s1,s2): # çº¯å‡½æ•°
    s = s1+s2
    return s
add([1,2,3],[4,5,6]) #> [1, 2, 3, 4, 5, 6]
```

ä»»ä½•èƒ½å¤Ÿç”¨ä¿®æ”¹å™¨å®ç°çš„å‡½æ•°åŒæ ·èƒ½å¤Ÿç”¨çº¯å‡½æ•°å®ç°ã€‚ä¸€äº›è¯æ®è¡¨æ˜ç”¨çº¯å‡½æ•°å®ç°çš„ç¨‹åºæ¯”ç”¨ä¿®æ”¹å™¨å®ç°çš„å‡½æ•°å¼€å‘æ›´å¿«ã€æ›´ä¸æ˜“å‡ºé”™ã€‚ ä½†æ˜¯æœ‰æ—¶å€™ä¿®æ”¹å™¨æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œè€Œå‡½æ•°å¼ç¨‹åºæ•ˆç‡åè€Œä¸é«˜ã€‚

é€šå¸¸æ¥è¯´ï¼Œåªè¦æ˜¯åœ¨åˆç†çš„æƒ…å†µä¸‹ï¼Œéƒ½æ¨èä½¿ç”¨çº¯å‡½æ•°æ–¹å¼ç¼–å†™ï¼Œåªåœ¨æœ‰å®Œå…¨ä»¤äººä¿¡æœçš„åŸå› ä¸‹æ‰é‡‡ç”¨ä¿®æ”¹å™¨ã€‚ è¿™ç§æ–¹æ³•è¢«ç§°ä¸ºå‡½æ•°å¼ç¼–ç¨‹é£æ ¼(*functional* *programming* *style*)â€”â€”åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œå¤§éƒ¨åˆ†å‡½æ•°éƒ½æ˜¯çº¯å‡½æ•°

## 5. ç›¸å…³æ¨¡å—

> å‚è€ƒ:ï¹æµç•…çš„ Pythonï¹-> 5.10 æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„åŒ…

æœ¬å°èŠ‚ä¼šä»‹ç»ä¸¤ä¸ªæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å—:  `operator` å’Œ `functools` 

åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œç»å¸¸éœ€ä½¿ç”¨ç®—æœ¯è¿ç®—ç¬¦çš„å‡½æ•°ç‰ˆæœ¬ã€‚ä¾‹å¦‚åœ¨è®¡ç®— `a+b`ï¼Œä¼šä½¿ç”¨ `sum(a,b)`ï¼›åœ¨è®¡ç®—é˜¶ä¹˜æ—¶ï¼Œä¼šä½¿ç”¨ `reduce(mul, range(1, n+1))`

### `operator` æ¨¡å—

> è¯¦è§ç¬”è®°:ï¹operator - Standard operators as functions.mdï¹

`operater` æ¨¡å—å¯¼å‡ºäº†ä¸€ç»„ä¸ Python çš„å†…éƒ¨è¿ç®—ç¬¦ç›¸å¯¹åº”çš„å‡½æ•°ã€‚ä¾‹å¦‚ `operator.mul(x, y)` ç­‰ä»·äºè¡¨è¾¾å¼ `x*y`ï¼Œä»è€Œé¿å…ç¼–å†™è¯¸å¦‚ `lambda x,y:x*y` è¿™æ ·çš„åŒ¿åå‡½æ•°ï¼š

```python
from functools import reduce
from operator import mul

def fact(n):
    return reduce(mul, range(1, n+1))
```

`operator` æ¨¡å—ä¸­è¿˜æœ‰ä¸€ç±»å‡½æ•°ï¼Œèƒ½æ›¿ä»£ä»åºåˆ—ä¸­å–å‡ºå…ƒç´ æˆ–è¯»å–å¯¹è±¡å±æ€§çš„ `lambda` è¡¨è¾¾å¼ï¼šå› æ­¤ï¼Œ`itemgetter` å’Œ `attrgetter` å…¶å®ä¼šè‡ªè¡Œæ„å»ºå‡½æ•°ã€‚

ç¤ºä¾‹ - æŒ‰ç…§å›½å®¶ä»£ç (ç¬¬ 2 ä¸ªå­—æ®µ)çš„é¡ºåºæ‰“å°å„ä¸ªåŸå¸‚çš„ä¿¡æ¯ã€‚`itemgetter(1)` çš„ä½œç”¨ä¸ `lambda fields: fields[1]` ä¸€æ ·ï¼šåˆ›å»ºä¸€ä¸ªæ¥å—é›†åˆçš„å‡½æ•°ï¼Œè¿”å›ç´¢å¼•ä½ 1 ä¸Šçš„å…ƒç´ ã€‚

```python
>>> metro_data = [
...     ('Tokyo', 'JP', 36.933, (35.689722, 139.691667)),
...     ('Delhi NCR', 'IN', 21.935, (28.613889, 77.208889)),
...     ('Mexico City', 'MX', 20.142, (19.433333, -99.133333)),
...     ('New York-Newark', 'US', 20.104, (40.808611, -74.020386)),
...     ('Sao Paulo', 'BR', 19.649, (-23.547778, -46.635833)),
... ]
>>>
>>> from operator import itemgetter
>>> for city in sorted(metro_data, key=itemgetter(1)):
...     print(city)
...
('Sao Paulo', 'BR', 19.649, (-23.547778, -46.635833))
('Delhi NCR', 'IN', 21.935, (28.613889, 77.208889))
('Tokyo', 'JP', 36.933, (35.689722, 139.691667))
('Mexico City', 'MX', 20.142, (19.433333, -99.133333))
('New York-Newark', 'US', 20.104, (40.808611, -74.020386))
```

å¦‚æœæŠŠå¤šä¸ªå‚æ•°ä¼ ç»™ `itemgetter`ï¼Œå®ƒæ„å»ºçš„å‡½æ•°ä¼šè¿”å›æå–çš„å€¼æ„æˆçš„å…ƒç»„ã€‚

`itemgetter` ä½¿ç”¨ `[]` è¿ç®—ç¬¦ï¼Œå› æ­¤å®ƒä¸ä»…æ”¯æŒåºåˆ—ï¼Œè¿˜æ”¯æŒæ˜ å°„å’Œä»»ä½•å®ç° `__getitem__` æ–¹æ³•çš„ç±»ã€‚

`attrgetter` ä¸ `itemgetter` ä½œç”¨ç±»ä¼¼ï¼Œå®ƒåˆ›å»ºçš„å‡½æ•°æ ¹æ®åç§°æå–å¯¹è±¡çš„å±æ€§ã€‚å¦‚æœæŠŠå¤šä¸ªå±æ€§åä¼ ç»™ `attrgetter`ï¼Œå®ƒä¹Ÿä¼šè¿”å›æå–çš„å€¼æ„æˆçš„å…ƒç»„ã€‚æ­¤å¤–ï¼Œå¦‚æœå‚æ•°åä¸­åŒ…å« `.`ï¼ˆç‚¹å·ï¼‰ï¼Œ`attrgetter` ä¼šæ·±å…¥åµŒå¥—å¯¹è±¡ï¼Œè·å–æŒ‡å®šçš„å±æ€§ã€‚

```python
>>> from collections import namedtuple
>>> metro_data = [
...     ('Tokyo', 'JP', 36.933, (35.689722, 139.691667)),
...     ('Delhi NCR', 'IN', 21.935, (28.613889, 77.208889)),
...     ('Mexico City', 'MX', 20.142, (19.433333, -99.133333)),
...     ('New York-Newark', 'US', 20.104, (40.808611, -74.020386)),
...     ('Sao Paulo', 'BR', 19.649, (-23.547778, -46.635833)),
... ]
>>>
>>> LatLong = namedtuple('LatLong', 'lat long')  # âŠ
>>> Metropolis = namedtuple('Metropolis', 'name cc pop coord')  # â‹
>>> metro_areas = [Metropolis(name, cc, pop, LatLong(lat, long))  # âŒ
...     for name, cc, pop, (lat, long) in metro_data]
>>> metro_areas[0]
Metropolis(name='Tokyo', cc='JP', pop=36.933, coord=LatLong(lat=35.689722,
long=139.691667))
>>> metro_areas[0].coord.lat  # â
35.689722
>>> from operator import attrgetter
>>> name_lat = attrgetter('name', 'coord.lat')  # â
>>>
>>> for city in sorted(metro_areas, key=attrgetter('coord.lat')):  # â
...     print(name_lat(city))  # â
...
('Sao Paulo', -23.547778)
('Mexico City', 19.433333)
('Delhi NCR', 28.613889)
('Tokyo', 35.689722)
('New York-Newark', 40.808611)
```

`methodcaller` åˆ›å»ºçš„å‡½æ•°ä¼šåœ¨å¯¹è±¡ä¸Šè°ƒç”¨å‚æ•°æŒ‡å®šçš„æ–¹æ³•

```python
>>> from operator import methodcaller
>>> s = 'The time has come'
>>> upcase = methodcaller('upper')
>>> upcase(s)
'THE TIME HAS COME'
>>> hiphenate = methodcaller('replace', ' ', '-')
>>> hiphenate(s)
'The-time-has-come'
```

### `functools` æ¨¡å—

> ç›¸å…³ç¬”è®°:ï¹functools - Higher-order functions and operations on callable objects.mdï¹

`functools` æ¨¡å—ç”¨äºé«˜é˜¶å‡½æ•°ï¼Œè¯¥æ¨¡å—æä¾›äº†è®¸å¤šæ”¹å†™æˆ–æ‹“å±•å‡½æ•°æˆ–å…¶ä»–å¯è°ƒç”¨å¯¹è±¡çš„å·¥å…·ï¼Œè€Œæ— éœ€å®Œå…¨é‡å†™å®ƒä»¬ã€‚ä¸‹é¢ç®€è¦ä»‹ç»å…¶ä¸­çš„ä¸¤ä¸ªå‡½æ•°ï¼š

ğŸ”¨ functools.reduce(*function*, *iterable*[, *initializer*])

è¯¥å‡½æ•°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

```python
reduce(f, [x1, x2, x3, x4]) = f(f(f(x1, x2), x3), x4)
```

è¯¦è§ç¬”è®°:ï¹functools - Higher-order functions and operations on callable objects.mdï¹

ğŸ”¨ functools.partial(*func*, \**args*, \*\**keywords*)

æ­¤é«˜é˜¶å‡½æ•°ç”¨äºéƒ¨åˆ†åº”ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå°†è¿”å›ä¸€ä¸ª `partial` å¯¹è±¡ã€‚éƒ¨åˆ†åº”ç”¨æ˜¯æŒ‡ï¼ŒåŸºäºä¸€ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å¯è°ƒç”¨å¯¹è±¡ï¼ŒæŠŠåŸå‡½æ•°çš„æŸäº›å‚æ•°å›ºå®šã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥æŠŠæ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°çš„å‡½æ•°æ”¹ç¼–æˆéœ€è¦å›è°ƒçš„ APIï¼Œè¿™æ ·å‚æ•°æ›´å°‘ã€‚

è¯¦è§ç¬”è®°:ï¹functools - Higher-order functions and operations on callable objects.mdï¹


