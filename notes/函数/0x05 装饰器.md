# 0x05 è£…é¥°å™¨

Decorator

> GitHub@[orca-j35](https://github.com/orca-j35)ï¼Œæ‰€æœ‰ç¬”è®°å‡æ‰˜ç®¡äº [python_notes](https://github.com/orca-j35/python_notes) ä»“åº“
>
> å‚è€ƒï¼š
>
> - ï¹æµç•…çš„ Pythonï¹-> ç¬¬ 7 ç«  å‡½æ•°è£…é¥°å™¨å’Œé—­åŒ…
>
> æ‰©å±•é˜…è¯»ï¼š
>
> - [Primer on Python Decorators â€“ Real Python](https://realpython.com/primer-on-python-decorators/) â­
> - [è£…é¥°å™¨ â€” Intermediate Python](https://eastlakeside.gitbooks.io/interpy-zh/content/decorators/)
> - [ä¼šæ‰“æ‰®çš„è£…é¥°å™¨ Â· Python ä¹‹æ—…](https://funhacks.net/explore-python/Functional/decorator.html)
> - [DRY Principles through Python Decorators](http://y.tsutsumi.io/dry-principles-through-python-decorators.html)
> - [è£…é¥°å™¨ - å»–é›ªå³°](https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014318435599930270c0381a3b44db991cd6d858064ac0000)
> - [Python çš„é—­åŒ…å’Œè£…é¥°å™¨](https://segmentfault.com/a/1190000004461404)
> - http://www.cnblogs.com/vamei/archive/2013/02/16/2820212.html
> - [PEP 318 -- Decorators for Functions and Methods](https://www.python.org/dev/peps/pep-0318/)
> - [PEP 318: Decorators for Functions and Methods - Whatâ€™s New in Python 2.4](https://docs.python.org/3.7/whatsnew/2.4.html?highlight=classmethod#pep-318-decorators-for-functions-and-methods)
> - [PEP 3129 -- Class Decorators](https://www.python.org/dev/peps/pep-3129/)
> - See the documentation for [function definitions](https://docs.python.org/3.7/reference/compound_stmts.html#function) and [class definitions](https://docs.python.org/3.7/reference/compound_stmts.html#class) for more about decorators.

è£…é¥°å™¨([*decorator*](https://docs.python.org/3.7/glossary.html#term-decorator))æ˜¯å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œå¯é€šè¿‡å‡½æ•°æˆ–ç±»å®ç°ï¼›è£…é¥°å™¨å‚æ•°å¯ä»¥æ˜¯å¦ä¸€ä¸ªå‡½æ•°(å‡½æ•°è£…é¥°å™¨)ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªç±»(ç±»è£…é¥°å™¨)ã€‚å…³äºç±»è£…é¥°å™¨ï¼Œè¯¦è§ï¹æµç•…çš„ Pythonï¹-> ç¬¬ 21 ç«  ç±»å…ƒç¼–ç¨‹ï¼Œè¿™é‡Œåªä»‹ç»å‡½æ•°è£…é¥°å™¨ã€‚

å‡è®¾å·²æœ‰åä¸º `decorate` çš„è£…é¥°å™¨ï¼š

```python
@decorate
def target():
    print('running target()')
```

é‚£ä¹ˆï¼Œä¸Šè¿°ä»£ç ä¸ä¸‹é¢çš„ä»£ç ç­‰æ•ˆï¼š

```python
def target():
    print('running target()')

target = decorate(target)
```

è£…é¥°å™¨ä»¥å¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè£…é¥°å™¨çš„è¿”å›å€¼å¯ä»¥æ˜¯ä»»æ„å¯è°ƒç”¨å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š

```python
def deco(func):
    def inner():
         print('running inner()')
    return inner # éœ€ä»¥å¯è°ƒç”¨å¯¹è±¡ä½œä¸ºè¿”å›å€¼

@deco
def target():
    print('running target()')

# å› ä¸ºè£…é¥°å™¨å°†innerä½œä¸ºè¿”å›å€¼ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨targetæ—¶ï¼Œå…¶å®ä¼šè¿è¡Œinner
target() #> running inner()
# targetç°åœ¨æŒ‡å‘inner
target #> <function __main__.deco.<locals>.inner>
```

ä¸¥æ ¼æ¥è¯´ï¼Œè£…é¥°å™¨åªæ˜¯è¯­æ³•ç³–ã€‚å¦‚å‰æ‰€ç¤ºï¼Œè£…é¥°å™¨å¯ä»¥åƒå¸¸è§„çš„å¯è°ƒç”¨å¯¹è±¡é‚£æ ·è°ƒç”¨ï¼Œå…¶å‚æ•°æ˜¯å¦ä¸€ä¸ªå‡½æ•°ã€‚

## å æ”¾è£…é¥°å™¨

```python
@d1
@d2
def f():
    print('f')
```

ç­‰æ•ˆäºï¼š

```python
def f():
    print('f')
f = d1(d2(f))
```

## ä½•æ—¶æ‰§è¡Œè£…é¥°å™¨

è£…é¥°å™¨ä¼šåœ¨è¢«è£…é¥°çš„å‡½æ•°å®šä¹‰åç«‹å³è¿è¡Œï¼Œå› æ­¤è£…é¥°å™¨ä¼šåœ¨åŠ è½½æ¨¡å—æ—¶ç«‹å³æ‰§è¡Œï¼Œä½†æ˜¯è¢«è£…é¥°çš„å‡½æ•°åªæœ‰åœ¨è°ƒç”¨æ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚

```python
# registration.py
# BEGIN REGISTRATION

registry = []  # ä¿å­˜è¢«@registerè£…é¥°è¿‡çš„å‡½æ•°çš„å¼•ç”¨

def register(func):  # è£…é¥°å™¨ä»¥å‡½æ•°ä½œä¸ºå‚æ•°
    print('running register(%s)' % func)
    registry.append(func)
    return func

@register # åœ¨å®šä¹‰f1ä¹‹åï¼Œç«‹å³è¿›è¡Œè£…é¥°
def f1():
    print('running f1()')

@register
def f2():
    print('running f2()')

def f3():
    print('running f3()')

def main():
    print('running main()')
    print('registry ->', registry)
    f1()
    f2()
    f3()

if __name__=='__main__':
    main()

# END REGISTRATION
```

ä½œä¸ºè„šæœ¬è¿è¡Œæ—¶ï¼Œ`$ python3 registration.py`ï¼š

```python
running register(<function f1 at 0x0000026286F5BAE8>)
running register(<function f2 at 0x0000026287038F28>)
running main()
registry -> [<function f1 at 0x0000026286F5BAE8>, <function f2 at 0x0000026287038F28>]
running f1()
running f2()
running f3()
```

ä½œä¸ºæ¨¡å—å¯¼å…¥æ—¶ï¼š

```python
>>> import registration
running register(<function f1 at 0x10063b1e0>)
running register(<function f2 at 0x10063b268>)
```

## å®ç°ç®€å•çš„è£…é¥°å™¨

```python
# clockdeco.py
import time
def clock(func):
    def clocked(*args):
        t0 = time.time()
        result = func(*args) # funcæ˜¯clockedçš„è‡ªç”±å˜é‡
        elapsed = time.time() - t0
        name = func.__name__
        arg_str = ', '.join(repr(arg) for arg in args)
        print('[%0.8fs] %s(%s) -> %r' % (elapsed, name, arg_str, result))
        return result
    return clocked # ç”¨clockedæ›¿æ¢func
```

ä½¿ç”¨ `clock` è£…é¥°å™¨ï¼š

```python
# clockdeco_demo.py

import time
from clockdeco import clock

@clock
def snooze(seconds):
    time.sleep(seconds)

@clock
def factorial(n):
    return 1 if n < 2 else n*factorial(n-1)
'''ç­‰ä»·äº
def factorial(n):
    return 1 if n < 2 else n*factorial(n-1)
factorial = clock(factorial)
'''

if __name__=='__main__':
    print('*' * 40, 'Calling snooze(.123)')
    snooze(.123)
    print('*' * 40, 'Calling factorial(6)')
    print('6! =', factorial(6))
    print(factorial) # factorialå·²æŒ‡å‘clock
```

è¾“å‡ºï¼š

```python
**************************************** Calling snooze(.123)
[0.12399006s] snooze(0.123) -> None
**************************************** Calling factorial(6)
[0.00000000s] factorial(1) -> 1
[0.00022674s] factorial(2) -> 2
[0.00036836s] factorial(3) -> 6
[0.00044465s] factorial(4) -> 24
[0.00044465s] factorial(5) -> 120
[0.00094700s] factorial(6) -> 720
6! = 720
<function clock.<locals>.clocked at 0x000001D45933C7B8>
```

`clockdeco.py` ä¸­å®ç°çš„ `clock` è£…é¥°å™¨æœ‰å‡ ä¸ªç¼ºç‚¹ï¼šä¸æ”¯æŒå…³é”®å­—å‚æ•°ï¼Œè€Œä¸”é®ç›–äº†è¢«è£…é¥°å‡½æ•°çš„ `__name__` å’Œ `__doc__` å±æ€§ã€‚ä¸‹é¢ä½¿ç”¨ [`functools.wraps`](https://docs.python.org/3.6/library/functools.html#functools.wraps) è£…é¥°å™¨æŠŠç›¸å…³çš„å±æ€§ä» `func` å¤åˆ¶åˆ° `clocked` ä¸­ã€‚æ­¤å¤–ï¼Œè¿™ä¸ªæ–°ç‰ˆè¿˜èƒ½æ­£ç¡®å¤„ç†å…³é”®å­—å‚æ•°ã€‚

```python
# clockdeco2.py

import time
import functools

def clock(func):
    @functools.wraps(func)
    def clocked(*args, **kwargs): # æ”¯æŒå…³é”®å­—å‚æ•°
        t0 = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - t0
        name = func.__name__
        arg_lst = []
        if args:
            arg_lst.append(', '.join(repr(arg) for arg in args))
        if kwargs:
            pairs = ['%s=%r' % (k, w) for k, w in sorted(kwargs.items())]
            arg_lst.append(', '.join(pairs))
        arg_str = ', '.join(arg_lst)
        print('[%0.8fs] %s(%s) -> %r ' % (elapsed, name, arg_str, result))
        return result
    return clocked
```

### ç¤ºä¾‹

åˆ›å»ºäº†ä¸€ä¸ª `retry` è£…é¥°å™¨ï¼Œå¦‚æœåœ¨è¿è¡Œä¸­æŠ›å‡ºäº†ä»»ä½•é”™è¯¯ï¼Œå®ƒå°±ä¼šå°è¯•é‡æ–°è¿è¡Œï¼Œç›´åˆ°æœ€å¤§æ¬¡æ•° 5 æ¬¡ï¼Œå¹¶ä¸”æ¯æ¬¡è¿è¡ŒæœŸé—´éƒ½ä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚è¿™åœ¨å¯¹ä¸€å°è¿œç¨‹è®¡ç®—æœºè¿›è¡Œç½‘ç»œè°ƒç”¨çš„æƒ…å†µååˆ†æœ‰ç”¨ï¼š

```python
# è¯¥ç¤ºä¾‹æ¥è‡ªï¹byte-of-pythonï¹
from time import sleep
from functools import wraps
import logging
logging.basicConfig()
log = logging.getLogger("retry")


def retry(f):
    @wraps(f)
    def wrapped_f(*args, **kwargs):
        MAX_ATTEMPTS = 5
        for attempt in range(1, MAX_ATTEMPTS + 1):
            try:
                return f(*args, **kwargs)
            except:
                log.exception("Attempt %s/%s failed : %s",
                              attempt,
                              MAX_ATTEMPTS,
                              (args, kwargs))
                sleep(10 * attempt)
        log.critical("All %s attempts failed : %s",
                     MAX_ATTEMPTS,
                     (args, kwargs))
    return wrapped_f


counter = 0


@retry
def save_to_database(arg):
    print("Write to a database or make a network call or etc.")
    print("This will be automatically retried if exception is thrown.")
    global counter
    counter += 1
    # è¿™å°†åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æŠ›å‡ºå¼‚å¸¸
    # åœ¨ç¬¬äºŒæ¬¡è¿è¡Œæ—¶å°†æ­£å¸¸å·¥ä½œï¼ˆä¹Ÿå°±æ˜¯é‡è¯•ï¼‰
    if counter < 2:
        raise ValueError(arg)


if __name__ == '__main__':
    save_to_database("Some bad value")
```

è¾“å‡ºï¼š

```
$ python more_decorator.py
Write to a database or make a network call or etc.
This will be automatically retried if exception is thrown.
ERROR:retry:Attempt 1/5 failed : (('Some bad value',), {})
Traceback (most recent call last):
  File "more_decorator.py", line 14, in wrapped_f
    return f(*args, **kwargs)
  File "more_decorator.py", line 39, in save_to_database
    raise ValueError(arg)
ValueError: Some bad value
Write to a database or make a network call or etc.
This will be automatically retried if exception is thrown.
```

## æ ‡å‡†åº“ä¸­çš„è£…é¥°å™¨

> è¯¦è§ï¼š
>
> - ï¹æµç•…çš„ Pythonï¹-> 7.8ã€€æ ‡å‡†åº“ä¸­çš„è£…é¥°å™¨
>
> - [functools â€” å‡½æ•°æ“ä½œå·¥å…·ç®±](https://pythoncaff.com/docs/pymotw/functools-function-operation-toolbox/92)

Python æœ‰ä¸‰ä¸ªå†…ç½®è£…é¥°å™¨å‡½æ•°ï¼š`@property` , `@classmethod` , `@staticmethod`ã€‚

ä½¿ç”¨ `@abc.abstractmethod` å¯å®ç°æŠ½è±¡æ–¹æ³•ï¼Œè§ç¬”è®°ï¹æŠ½è±¡æ–¹æ³•.mdï¹

åœ¨æ ‡å‡†åº“çš„ `functools` æ¨¡å—ä¸­ä¹Ÿæä¾›äº†ä¸€äº›è£…é¥°å™¨ï¼Œè¿™é‡Œä»‹ç»ä¸‰ä¸ªå¸¸è§çš„ï¼š

- ğŸ”¨ @functools.lru_cache(*maxsize=128*, *typed=False*)

  è¯¥è£…é¥°å™¨å®ç°äº†å¤‡å¿˜(memoization)åŠŸèƒ½ï¼Œä¼šè®©æŸå‡½æ•°å…·æœ‰æœ€è¿‘æœ€å°ç¼“å­˜æœºåˆ¶ã€‚æ‰€æœ‰ä¼ é€’è¿‡æ¥çš„å‚æ•°éƒ½ä¼šè¢«å“ˆå¸ŒåŒ–ï¼Œç”¨äºåç»­ç»“æœçš„æ˜ å°„ã€‚ä¹‹åå†æ¬¡è°ƒç”¨ç›¸åŒçš„å‚æ•°æ—¶ä¼šä»ç¼“å­˜ä¸­ç›´æ¥è°ƒå–å‡ºç»“æœè€Œä¸å†ç»è¿‡å‡½æ•°è¿ç®—ã€‚åŒæ—¶æ­¤è£…é¥°å™¨è¿˜ç»™åŸå‡½æ•°åŠ äº†ä¸€ä¸ªç”¨äºæ£€æµ‹ç¼“å­˜çŠ¶æ€çš„æ–¹æ³•(`cache_info()`)å’Œä¸€ä¸ªæ¸…ç©ºç¼“å­˜çš„æ–¹æ³•(`cache_clear()`)ã€‚

- ğŸ”¨ @functools.singledispatch

  åœ¨åŠ¨æ€ç±»å‹è¯­è¨€(å¦‚ Python)ä¸­ï¼Œç»å¸¸æœ‰åœ¨æ‰§è¡Œæ—¶éœ€è¦è¾¨åˆ«ä¸åŒç±»å‹çš„å‚æ•°çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¦å¤„ç†çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨é‡Œçš„æ•°æ®è¿˜æ˜¯ä¸€ä¸ªå•ä¸ªçš„æ•°æ®ã€‚ç›´æ¥æ£€æµ‹å‚æ•°çš„ç±»å‹å½“ç„¶ç®€å•ï¼Œä½†ä¸åŒçš„åŠŸèƒ½ä¹Ÿå¯ä»¥å†™åˆ°ä¸åŒçš„å‡½æ•°ä¸­ï¼Œæ‰€ä»¥ `functools` æä¾›äº† `singledispatch()` è£…é¥°å™¨æ¥è®©æˆ‘ä»¬æ³¨å†Œ *æ³›å‹å‡½æ•°* ä»¥è‡ªåŠ¨åŸºäºç±»å‹è¿›è¡Œåˆ‡æ¢ã€‚

- ğŸ”¨ @functools.wraps(*wrapped*, *assigned=WRAPPER_ASSIGNMENTS*, *updated=WRAPPER_UPDATES*)

  ä½¿ç”¨è£…é¥°å™¨æ—¶ï¼ŒåŸå‡½æ•°åä¼šæŒ‡å‘è£…é¥°å™¨è¿”å›çš„å‡½æ•°ï¼Œå› æ­¤ `__name__` ç­‰å±æ€§ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¾‹å¦‚ï¼š

  ```python
  def log(func):
      def wrapper(*args, **kw):
          print('call %s():' % func.__name__)
          return func(*args, **kw) 
      return wrapper
      
  @log
  def now():
      print('2017-7-21')
  
  now.__name__ #> 'wrapper'
  now()
  #> call now():
     2017-7-21
  ```

  è¿™ä¼šå¯¼è‡´æŸäº›ä¾èµ–å‡½æ•°ç­¾åçš„ä»£ç ï¼Œåœ¨æ‰§è¡Œæ—¶å‡ºé”™ã€‚ä¸ºäº†é¿å…è¿™æ ·çš„é”™è¯¯ï¼Œéœ€è¦æŠŠåŸ `now` å‡½æ•°å¯¹è±¡ä¸­çš„ `__name__` ç­‰å±æ€§å¤åˆ¶åˆ° `wrapper` å‡½æ•°å¯¹è±¡ä¸­ã€‚`functools.wraps` è£…é¥°å™¨å¯æŠŠç›¸å…³çš„å±æ€§ä» `now` å¤åˆ¶åˆ° `wrapper` ä¸­ï¼Œå¹¶ä¸éœ€è¦é¢å¤–ç¼–å†™ `wrapper.__name__ = func.__name__` è¿™æ ·çš„ä»£ç ã€‚

  å› æ­¤ï¼Œä¸€ä¸ªå®Œæ•´çš„è£…é¥°å™¨çš„å†™æ³•å¦‚ä¸‹ï¼š

  ```python
  import functools
  
  def log(func):
      @functools.wraps(func)
      def wrapper(*args, **kw):
          print('call %s():' % func.__name__)
          return func(*args, **kw)
      return wrapper
  ```

  `@functools.wraps` è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹ç‚¹ï¼šå¯ä»¥é€šè¿‡ `__wrapped__` å†æ¬¡è®¿é—®åŸå‡½æ•°ï¼Œå¦‚ `func.__wrapped__(*args,**kwargs)`ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

  - å¦‚æœæœ‰å¤šä¸ªè£…é¥°å™¨åŒæ—¶ç”¨ä¸Šè¿°æ–¹æ³•è£…é¥°æŸä¸ªå‡½æ•°ï¼Œåˆ™ `__wrapped__` å¾—åˆ°çš„ç»“æœä¸å¯é¢„çŸ¥ã€‚ä¹Ÿå¯èƒ½æ˜¯åŸå‡½æ•°ï¼Œæˆ–è§£é™¤ä¸€ä¸ªè£…é¥°å™¨æ•ˆæœã€‚
  - å†…ç½®çš„è£…é¥°å™¨ `@staticmethod` å’Œ `@classmethod` å°±æ²¡æœ‰éµå¾ªè¿™ä¸ªçº¦å®š (å®ƒä»¬æŠŠåŸå§‹å‡½æ•°å­˜å‚¨åœ¨å±æ€§ `__func__` ä¸­)ã€‚


## å‚æ•°åŒ–è£…é¥°å™¨

åˆ›å»ºä¸€ä¸ªè£…é¥°å™¨å·¥å‚å‡½æ•°ï¼ŒæŠŠå‚æ•°ä¼ ç»™å®ƒï¼Œè¿”å›ä¸€ä¸ªè£…é¥°å™¨ï¼Œç„¶åå†æŠŠå®ƒåº”ç”¨åˆ°è¦è£…é¥°çš„å‡½æ•°ä¸Šã€‚

ä¸ºäº†ä¾¿äºç†è§£ï¼Œå…ˆç»™å‡ºä¸€ä¸ªæ— å‚æ•°çš„è£…é¥°å™¨ï¼š

```python
# registration.py 
registry = []

def register(func):
    print('running register(%s)' % func)
    registry.append(func)
    return func

@register
def f1():
    print('running f1()')

print('running main()')
print('registry ->', registry)
f1()
```

ä¸ºäº†ä¾¿äºå¯ç”¨æˆ–ç¦ç”¨ `register` æ‰§è¡Œçš„å‡½æ•°æ³¨å†ŒåŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸ºå®ƒæä¾›ä¸€ä¸ªå¯é€‰çš„ `active` å‚æ•°ï¼Œè®¾ä¸º `False` æ—¶ï¼Œä¸æ³¨å†Œè¢«è£…é¥°çš„å‡½æ•°ã€‚ä½†æ˜¯ä»æ¦‚å¿µä¸Šçœ‹ï¼Œä¸‹é¢è¿™ä¸ªæ–°çš„ `register` å‡½æ•°å¹¶ä¸æ˜¯è£…é¥°å™¨ï¼Œè€Œæ˜¯è£…é¥°å™¨å·¥å‚å‡½æ•°ã€‚éœ€è¦è°ƒç”¨å®ƒæ‰ä¼šè¿”å›çœŸæ­£çš„è£…é¥°å™¨ï¼Œè¿™æ‰æ˜¯åº”ç”¨åˆ°ç›®æ ‡å‡½æ•°ä¸Šçš„è£…é¥°å™¨ã€‚

```python
# BEGIN REGISTRATION_PARAM

registry = set()  # ä½¿ç”¨setï¼Œå¯è·å¾—æ›´å¿«çš„æ·»åŠ å’Œåˆ é™¤é€Ÿåº¦

def register(active=True):  # è£…é¥°å™¨å·¥å‚å‡½æ•°ï¼Œå¯æ¥å—å‚æ•°
    def decorate(func):  # è¿™æ‰æ˜¯çœŸæ­£çš„è£…é¥°å™¨ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚
        print('running register(active=%s)->decorate(%s)'
              % (active, func))
        if active:   # <4>
            registry.add(func)
        else:
            registry.discard(func)  # <5>
            
        return func  # è£…é¥°å™¨å¿…é¡»è¿”å›ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡
    return decorate  # è£…é¥°å™¨å·¥å‚å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè£…é¥°å™¨

@register(active=False)  # å¿…éœ€è°ƒç”¨å·¥å‚å‡½æ•°
def f1():
    print('running f1()')

@register()  # å¿…éœ€è°ƒç”¨å·¥å‚å‡½æ•°
def f2():
    print('running f2()')

def f3():
    print('running f3()')

# END REGISTRATION_PARAM
```

è¾“å‡ºï¼š

```python
running register(active=False)->decorate(<function f1 at 0x000002A30EFDC950>)
running register(active=True)->decorate(<function f2 at 0x000002A30EFDC9D8>)
```

å¦‚æœä¸ä½¿ç”¨ `@` å¥æ³•ï¼Œé‚£å°±è¦åƒå¸¸è§„å‡½æ•°é‚£æ ·ä½¿ç”¨ `register`ï¼›è‹¥æƒ³æŠŠ `f` æ·»åŠ åˆ° `registry` ä¸­ï¼Œåˆ™è£…é¥° `f` å‡½æ•°çš„å¥æ³•æ˜¯ `register()(f)`ï¼›ä¸æƒ³æ·»åŠ ï¼ˆæˆ–æŠŠå®ƒåˆ é™¤ï¼‰çš„è¯ï¼Œå¥æ³•æ˜¯ `register(active=False)(f)`ã€‚

ä¸‹é¢æ¥çœ‹ä¸€ä¸ªå¤æ‚ä¸€ç‚¹çš„ä¾‹å­ï¼š

```python
import functools
def log(text):
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kw): # å¢åŠ äº†ä¸€å±‚å‡½æ•°
            print('%s %s():' % (text, func.__name__))
            return func(*args, **kw)
        return wrapper
    return decorator
```

## åŸºäºç±»çš„è£…é¥°å™¨

åŒæ ·å¯ä»¥åŸºäºç±»æ¥å®ç°è£…é¥°å™¨ï¼Œä¾‹å¦‚ï¼š

```python
class Bold(object):
    def __init__(self, func):
        self.func = func

    def __call__(self, *args, **kwargs):
        return '<b>' + self.func(*args, **kwargs) + '</b>'

@Bold
def hello(name):
    return 'hello %s' % name

>>> hello('world')
'<b>hello world</b>'
```

å¯ä»¥çœ‹åˆ°ï¼Œç±» `Bold` æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š

- `__init__()`ï¼šå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¢«è£…é¥°çš„å‡½æ•°
- `__call__()`ï¼šè®©ç±»å¯¹è±¡å¯è°ƒç”¨ï¼Œå°±åƒå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œåœ¨è°ƒç”¨è¢«è£…é¥°å‡½æ•°æ—¶è¢«è°ƒç”¨

è¿˜å¯ä»¥è®©ç±»è£…é¥°å™¨å¸¦å‚æ•°ï¼š

```python
class Tag(object):
    def __init__(self, tag):
        self.tag = tag

    def __call__(self, func):
        def wrapped(*args, **kwargs):
            return "<{tag}>{res}</{tag}>".format(
                res=func(*args, **kwargs), tag=self.tag
            )
        return wrapped

@Tag('b')
def hello(name):
    return 'hello %s' % name
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç±»è£…é¥°å™¨æœ‰å‚æ•°ï¼Œåˆ™ `__init__` æ¥æ”¶å‚æ•°ï¼Œè€Œ `__call__` æ¥æ”¶ `func`ã€‚

### å‚æ•°åŒ–

ä¸‹é¢è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•å°†åŸºäºç±»çš„è£…é¥°å™¨å‚æ•°åŒ–ï¼š

```python
from functools import wraps

class logit(object):
    def __init__(self, logfile='out.log'):
        self.logfile = logfile

    def __call__(self, func):
        @wraps(func) # wraps
        def wrapped_function(*args, **kwargs):
            log_string = func.__name__ + " was called"
            print(log_string)
            # æ‰“å¼€logfileå¹¶å†™å…¥
            with open(self.logfile, 'a') as opened_file:
                # ç°åœ¨å°†æ—¥å¿—æ‰“åˆ°æŒ‡å®šçš„æ–‡ä»¶
                opened_file.write(log_string + '\n')
            # ç°åœ¨ï¼Œå‘é€ä¸€ä¸ªé€šçŸ¥
            self.notify()
            return func(*args, **kwargs)
        return wrapped_function

    def notify(self):
        # logitåªæ‰“æ—¥å¿—ï¼Œä¸åšåˆ«çš„
        pass
```

å‚è€ƒè‡ª: https://eastlakeside.gitbooks.io/interpy-zh/content/decorators/deco_class.html

## ä½¿ç”¨åœºæ™¯

ç”¨è£…é¥°å™¨å®ç°è®¾è®¡æ¨¡å¼ä¸­çš„å•ä¾‹æ¨¡å¼(singleton)

```
def singleton(cls, *args, **kwargs):
    instance = {}

    def __singleton():
        if cls not in instance:
            instance[cls] = cls
        return instance[cls]

    return __singleton


@singleton
class MyClass:
    kind = "type"

    def __init__(self, name):
        self.name = name


@singleton
class MyAnotherClass:
    name = "another"

    def __init__(self, age):
        self.age = age


one = MyClass()
two = MyClass()
print(id(one))
print(id(two))


another_one = MyAnotherClass()
another_two = MyAnotherClass()
print(id(another_one))
print(id(another_two))
```

## ç±»è£…é¥°å™¨

```python
def decorator(aClass):
    class newClass:
        def __init__(self, age):
            self.total_display   = 0
            self.wrapped = aClass(age)
        def display(self):
            self.total_display += 1
            print("total display", self.total_display)
            self.wrapped.display()
    return newClass

@decorator
class Bird:
    def __init__(self, age):
        self.age = age
    def display(self):
        print("My age is",self.age)

eagleLord = Bird(5)
for i in range(3):
    eagleLord.display()
```



