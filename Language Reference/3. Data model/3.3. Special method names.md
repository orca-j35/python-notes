# 3.3. Special method names

> GitHub@[orca-j35](https://github.com/orca-j35)ï¼Œæ‰€æœ‰ç¬”è®°å‡æ‰˜ç®¡äº [python_notes](https://github.com/orca-j35/python_notes) ä»“åº“
>

## [3.3.1. Basic customization](https://docs.python.org/3.7/reference/datamodel.html#basic-customization)

### \_\_new\_\_

ğŸ”¨ object.\_\_new\_\_(*cls*[, ...])

åœ¨æ–°å¼ç±»ä¸­ï¼Œ `__new__` ç”¨äºæ§åˆ¶æ–°å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œ`__init__` ç”¨äºæ§åˆ¶æ–°å®ä¾‹çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚ç”±äº object ç±»ä¸­å·²åŒ…å« `__new__`ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªæ–°å¼ç±»å‡æ‹¥æœ‰è¯¥æ–¹æ³•ã€‚å¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œæœ¬èŠ‚å†…å®¹å‡é’ˆå¯¹æ–°å¼ç±»ä¸­çš„ `__new__` æ–¹æ³•è¿›è¡Œè®¨è®ºã€‚

æ–°å¼ç±»ä¸­çš„ `__new__` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„**é™æ€æ–¹æ³•**ï¼Œæ— éœ€åœ¨å£°æ˜è¿‡ç¨‹ä¸­æ˜¾å¼ä½¿ç”¨ `@staticmethod` è£…é¥°å™¨ã€‚`__new__` æ–¹æ³•çš„**å®å‚**ç”±"ç±»å¼•ç”¨"å’Œ"æ„é€ å™¨å®å‚åˆ—è¡¨"å…±åŒç»„æˆã€‚

å½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªç±»çš„æ„é€ å™¨(*constructor*)æ—¶ï¼Œä¾¿ä¼šå…ˆè°ƒç”¨è¯¥ç±»çš„ `__new__` æ–¹æ³•ã€‚æ ¹æ® `__new__` è¿”å›å€¼çš„ä¸åŒï¼Œå¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

- å¦‚æœè¿”å›å€¼æ˜¯ *cls* çš„å®ä¾‹ï¼Œä¹‹åä¾¿ä¼šè°ƒç”¨è¯¥å®ä¾‹çš„ `__init__` æ–¹æ³•ã€‚`__init__` æ–¹æ³•çš„å®å‚ç”±"å®ä¾‹å¼•ç”¨"å’Œ"æ„é€ å™¨å®å‚åˆ—è¡¨"å…±åŒç»„æˆï¼Œä¹Ÿå°±æ˜¯è¯´ `__new__` å’Œ `__init__` é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°ä¸åŒä¹‹å¤–ï¼Œ**å…¶ä½™å‚æ•°å‡ç›¸åŒ**ã€‚

  ä¸º *cls* ç±»åˆ›å»ºæ–°å®ä¾‹çš„å…¸å‹æ–¹æ³•æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š

  - é€šè¿‡ `super()` è°ƒç”¨å…¶çˆ¶ç±»çš„  `__new__` æ–¹æ³•ï¼Œå¦‚ `super().__new__(cls[, ...])`ã€‚
  - ç›´æ¥è°ƒç”¨ object ç±»çš„ `__new__` æ–¹æ³•ï¼Œå¦‚ `object.__new__(cls)`

  å¦å¤–ï¼Œåœ¨ `__new__` è¿”å›å®ä¾‹å‰ï¼Œè¿˜å¯æ ¹æ®éœ€è¦å¯¹å·²åˆ›å»ºçš„å®ä¾‹è¿›è¡Œä¿®æ”¹ã€‚

  ```python
  class A(object):
      def __new__(cls, a_str): 
          # ç‰¹æ®Šé™æ€æ–¹æ³•ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨@staticmethodè£…é¥°å™¨
          print("into __new__")
          # objectç±»çš„__new__æ–¹æ³•åªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥åªéœ€ä¼ é€’ä¸€ä¸ªå‚æ•°å³å¯
          instance = super().__new__(cls) # åˆ›å»ºå®ä¾‹
          instance.num = 61  # å¦‚æœéœ€è¦çš„è¯ï¼Œå¯å¯¹å®ä¾‹è¿›è¡Œä¿®æ”¹
          return instance # è¿”å›è¯¥å®ä¾‹
  
      def __init__(self, a_str):
          print("into __init__")
          print(self.num)
  A("hello") # æ‰§è¡Œæ„é€ å™¨è¡¨è¾¾å¼
  ```

  è¾“å‡ºï¼š

  ```
  into __new__
  into __init__
  61
  ```

- å¦‚æœè¿”å›å€¼å¹¶é *cls* çš„å®ä¾‹ï¼Œé‚£ä¹ˆå°†ä¸ä¼šè°ƒç”¨è¯¥å®ä¾‹çš„ `__init__` æ–¹æ³•

  ```python
  class Sample(object):
      def __init__(self): # ä¸ä¼šè¢«è°ƒç”¨
          print("Sample's __init__")
  
      def __str__(self):
          return "SAMPLE"
  
  class A(object):
      def __new__(cls):
          """å¹¶ä¸ä¼šè°ƒç”¨Sampleæˆ–Aä¸­çš„__init__æ–¹æ³•"""
          return super().__new__(Sample)  # è¿”å›ä¸€ä¸ªSampleå®ä¾‹
      	# ä¹Ÿå¯è¿”å›å­—ç¬¦ä¸²ã€æ•´æ•°ã€Noneã€å‡½æ•°å¯¹è±¡ç­‰ï¼Œä½†éƒ½ä¸ä¼šè°ƒç”¨__init__æ–¹æ³•
  
      def __init__(self): # ä¸ä¼šè¢«è°ƒç”¨
          print("A's __init__")
  
  print(A())
  ```

  è¾“å‡ºï¼š

  ```
  SAMPLE
  ```

#### a. Tips

- åœ¨æ—§å¼ç±»ä¸­å¹¶æ²¡æœ‰ `__new__` æ–¹æ³•ï¼Œåªæœ‰ `__init__` æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰å¦‚ä¸‹æ—§ç±»ï¼š

  ```python
  # -*- coding: utf-8 -*-
  # python2
  class oldStyleClass:
      def __new__(cls):
          # æ—§å¼ç±»åœ¨æ„é€ å®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè°ƒç”¨__new__æ–¹æ³•
          print("into __new__")
  
      def __init__(self):
          print("into __init__")
  
  
  oldStyleClass()
  ```

  è¾“å‡ºç»“æœå°†ä¼šæ˜¯ï¼š

  ```
  into __init__
  ```

  å¯è§ï¼Œæ—§å¼ç±»åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹å¹¶ä¸ä¼šè°ƒç”¨ `__new__` æ–¹æ³•ã€‚

- åªè¦è¿”å›å€¼æ˜¯ *cls* çš„å®ä¾‹ï¼Œä¾¿ä¼šè°ƒç”¨è¯¥å®ä¾‹çš„ `__init__` æ–¹æ³•ï¼Œæ— è®ºæ˜¯å¦å·²ç»è°ƒç”¨è¿‡ï¼š

  ```python
  class AbstractClass(object):
      def __new__(cls, a, b):
          instance = super(AbstractClass, cls).__new__(cls)
          instance.__init__(a, b)
          return instance  # åªè¦è¿”å›å®ä¾‹ä¾¿ä¼šè°ƒç”¨initï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ä¸¤æ¬¡
  
      def __init__(self, a, b):
          print("into __init__")
  
  
  AbstractClass(1, 2)
  ```

  è¾“å‡ºï¼š

  ```
  into __init__
  into __init__
  ```

#### b. åº”ç”¨åœºæ™¯

- å½“æˆ‘ä»¬ç»§æ‰¿æŸä¸ª**ä¸å¯å˜ç±»å‹**(å¦‚ intã€strã€tuple)æ—¶ï¼Œå¯é€šè¿‡ `__new__` æ–¹æ³•è‡ªå®šä¹‰å­ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¸º int ç±»åˆ›å»ºä¸€ä¸ªå§‹ç»ˆå­˜å‚¨æ­£æ•°çš„å­ç±»æ—¶ï¼Œä¾¿éœ€è¦è¦†å†™ `__new__` æ–¹æ³•ï¼š

  ```python
  class PositiveInteger(int):
      def __new__(cls, value):
          return super(PositiveInteger, cls).__new__(cls, abs(value))
  
  i = PositiveInteger(-6)
  print(i) # è¾“å‡º 6
  ```

  å¦‚æœæˆ‘ä»¬è¯•å›¾é€šè¿‡é‡è½½ `__init__` æ¥å®ç°ä¸Šè¿°åŠŸèƒ½ï¼Œä¼šå‘ç°åœ¨ Python 3 ä¸­ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

  ```python
  class PositiveInteger(int):
      def __init__(self, value):
          super(PositiveInteger, self).__init__(abs(value)) 
          # Python3ä¼šæŠ›å‡ºTypeError
          # Python2å¯æ­£å¸¸è¿è¡Œï¼Œä½†æœ€ç»ˆçš„è¾“å‡ºç»“æœä»æ˜¯ -6
  
  i = PositiveInteger(-6)
  print(i) # Python2è¾“å‡º-6
  ```

- å¯ä»¥ç”¨ `__new__` æ¥å®ç°è®¾è®¡æ¨¡å¼ä¸­çš„**å•ä¾‹æ¨¡å¼**(singleton)

  ```python
  class Singleton(object):
      def __new__(cls):
          # æ¯æ¬¡å®ä¾‹åŒ–çš„æ—¶ï¼Œå‡ä¼šè¿”å›åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡
          if not hasattr(cls, 'instance'):
              cls.instance = super().__new__(cls)
          return cls.instance
  
      def __init__(self):
          print("into __init__")
  
  # è™½ç„¶æ¯æ¬¡å®ä¾‹åŒ–æ—¶ï¼Œå‡ä¼šè¿”å›åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œ
  # ä½†æ˜¯ï¼Œä»»ç„¶ä¼šè°ƒç”¨ä¸¤æ¬¡__init__æ–¹æ³•
  inst_1 = Singleton()
  inst_2 = Singleton()
  
  inst_1.attr = 'value'
  print(inst_1.attr, inst_2.attr)
  print(inst_1 is inst_2)
  ```

  è¾“å‡º

  ```
  into __init__
  into __init__
  value value
  True
  ```

- å¯åˆ©ç”¨ `__new__` æ¥**é™åˆ¶å®ä¾‹çš„æ€»æ•°**

  ```python
  class LimitedInstances(object):
      _instances = []  # å­˜æ”¾å·²æœ‰å®ä¾‹å¼•ç”¨çš„åˆ—è¡¨
      limit = 5 
  
      def __new__(cls, *args, **kwargs):
          if not len(cls._instances) <= cls.limit:
              raise RuntimeError, "Count not create instance. Limit %s reached" % cls.limit    
          instance = object.__name__(cls, *args, **kwargs)
          cls._instances.append(instance)
          return instance
      
      def __del__(self):
          # Remove instance from _instances 
          self._instance.remove(self)
  ```

- è¦†å†™è‡ªå®šä¹‰å…ƒç±»çš„ `__new__`ï¼Œä»è€Œå½±å“ç±»å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚

  ```python
  # -*- coding: utf-8 -*-
  class Meta(type):  # è‡ªå®šä¹‰å…ƒç±»éœ€ç»§æ‰¿è‡ªtype
      def __new__(cls, name, bases, dct):  # __new__æ–¹æ³•çš„å‚æ•°éœ€å’Œtypeä¸€è‡´
          # éœ€é€šè¿‡superè°ƒç”¨çˆ¶ç±»çš„__new__æ–¹æ³•æ¥æ„é€ æ–°çš„ç±»å¯¹è±¡
          x = super().__new__(cls, name, bases, dct) 
          x.attr_of_new = 100 # åœ¨å…ƒç±»ä¸­ä¸ºç±»å¯¹è±¡æ·»åŠ è‡ªå®šä¹‰å±æ€§
          return x # æœ€åéœ€è¿”å›ç±»å¯¹è±¡
      def __init__(self, name, bases, dct):
          self.attr_of_init = 200
          super().__init__(name, bases, dict)
  ```

  è¾“å‡ºï¼š

  ```python
  >>> class Foo(metaclass=Meta): # éœ€ä½¿ç”¨metaclasså…³é”®å­—æŒ‡å®šç›®æ ‡å…ƒç±»
  ...     pass
  ...
  >>> Foo.attr_of_new # Metaå…ƒç±»ä¸ºFooæ·»åŠ äº†å±æ€§
  100
  >>> Foo.attr_of_init 
  200
  ```


#### c. å‚è€ƒ

- [Python: \_\_new\_\_ magic method explained](https://howto.lintel.in/python-__new__-magic-method-explained/)

### \_\_init\_\_

ğŸ”¨ object.\_\_init\_\_(*self*[, ...])

åœ¨æ–°å¼ç±»ä¸­ï¼Œ `__new__` ç”¨äºæ§åˆ¶æ–°å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œ`__init__` ç”¨äºæ§åˆ¶æ–°å®ä¾‹çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚å¦‚æœ `__new__` çš„è¿”å›å€¼æ˜¯å½“å‰ç±»çš„å®ä¾‹ï¼Œä¹‹åä¾¿ä¼šè°ƒç”¨è¯¥å®ä¾‹çš„ `__init__` æ–¹æ³•ï¼Œæ¥å¯¹å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨å®Œæˆåˆå§‹åŒ–åæ‰ä¼šå°†å®ä¾‹è¿”å›ç»™è°ƒç”¨è€…ã€‚

`__init__` çš„å®å‚ç”±"å®ä¾‹å¼•ç”¨"å’Œ"æ„é€ å™¨å®å‚åˆ—è¡¨"å…±åŒç»„æˆï¼Œä¹Ÿå°±æ˜¯è¯´ `__new__` å’Œ `__init__` é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°ä¸åŒä¹‹å¤–ï¼Œ**å…¶ä½™å‚æ•°å‡ç›¸åŒ**ã€‚`__init__` åªèƒ½è¿”å› `None`ï¼Œå¦åˆ™ä¼šæŠ›å‡º [`TypeError`](https://docs.python.org/3.7/library/exceptions.html#TypeError)ã€‚

å‡è®¾åŸºç±»ä¸­å®šä¹‰äº† `__init__` æ–¹æ³•ï¼Œå¦‚æœæ´¾ç”Ÿç±»ä¸­è¦†å†™äº† `__init__` æ–¹æ³•ï¼Œåˆ™åœ¨æ´¾ç”Ÿç±»çš„ `__init__` æ–¹æ³•ä¸­å¿…é¡»æ˜¾å¼è°ƒç”¨çˆ¶ç±»ä¸­çš„ `__init__` æ–¹æ³•ï¼Œä»¥ç¡®ä¿èƒ½å¤Ÿæ­£ç¡®åˆå§‹åŒ–å®ä¾‹çš„åŸºç±»éƒ¨åˆ†ï¼Œå¦‚ï¼š`super().__init__([args...])`ã€‚

#### a. Tips

- åœ¨æ—§å¼ç±»ä¸­å¹¶æ²¡æœ‰ `__new__` æ–¹æ³•ï¼Œåªæœ‰ `__init__` æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰å¦‚ä¸‹æ—§ç±»ï¼š

  ```python
  # -*- coding: utf-8 -*-
  # python2
  class oldStyleClass:
      def __new__(cls):
          # æ—§å¼ç±»åœ¨æ„é€ å®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè°ƒç”¨__new__æ–¹æ³•
          print("into __new__")
  
      def __init__(self):
          print("into __init__")
  
  
  oldStyleClass()
  ```

  è¾“å‡ºç»“æœå°†ä¼šæ˜¯ï¼š

  ```
  into __init__
  ```

  å¯è§ï¼Œæ—§å¼ç±»åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹å¹¶ä¸ä¼šè°ƒç”¨ `__new__` æ–¹æ³•ã€‚

- åªè¦è¿”å›å€¼æ˜¯ *cls* çš„å®ä¾‹ï¼Œä¾¿ä¼šè°ƒç”¨è¯¥å®ä¾‹çš„ `__init__` æ–¹æ³•ï¼Œæ— è®ºè¯¥æ–¹æ³•æ˜¯å¦å·²ç»è°ƒç”¨è¿‡ï¼š

  ```python
  class AbstractClass(object):
      def __new__(cls, a, b):
          instance = super(AbstractClass, cls).__new__(cls)
          instance.__init__(a, b)
          return instance  # åªè¦è¿”å›å®ä¾‹ä¾¿ä¼šè°ƒç”¨initï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ä¸¤æ¬¡
  
      def __init__(self, a, b):
          print("into __init__")
  
  
  AbstractClass(1, 2)
  ```

  è¾“å‡ºï¼š

  ```
  into __init__
  into __init__
  ```

### \_\_repr\_\_

> ç›¸å…³ç¬”è®°:ã€repr.mdã€

ğŸ”¨ object.\_\_repr\_\_(*self*)

è¯¥æ–¹æ³•ç”± [`repr()`](https://docs.python.org/3.7/library/functions.html#repr) è°ƒç”¨ï¼Œå…¶è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡â€”â€”è¯¥å­—ç¬¦ä¸²ç”¨äºè¡¨ç¤ºå¯¹è±¡çš„"æ­£å¼(*official*)"å½¢å¼ã€‚

å¦‚æœå¯èƒ½çš„è¯ï¼Œ`__repr__` è¿”å›çš„å­—ç¬¦ä¸²åº”è¯¥åƒä¸€ä¸ª**æœ‰æ•ˆçš„ Python è¡¨è¾¾å¼**ï¼Œå¹¶ä¸”å¯ç”¨å…¶é‡æ–°åˆ›å»ºä¸€ä¸ªå…·å¤‡ç›¸åŒå€¼çš„å¯¹è±¡(éœ€ç»™å®šæ°å½“çš„ç¯å¢ƒ)ã€‚

å¦‚æœæ²¡æ³•è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„è¡¨è¾¾å¼ï¼Œåˆ™åº”è¿”å›å½¢å¦‚ `<...some useful description...>` çš„å­—ç¬¦ä¸²ã€‚

å¦‚æœæŸä¸ªç±»å®šä¹‰äº† `__repr__` ä½†æ²¡æœ‰å®šä¹‰ `__str__`ï¼Œé‚£ä¹ˆå½“éœ€è¦è¯¥ç±»çš„å®ä¾‹çš„"éæ­£å¼(*informal*)"å­—ç¬¦ä¸²è¡¨ç¤ºæ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨ `__repr__()`ã€‚

é€šå¸¸ä¼šåœ¨è°ƒè¯•æ—¶ä½¿ç”¨ `__repr__` ï¼Œå› æ­¤åœ¨æè¿°å¯¹è±¡æ—¶æœ€é‡è¦çš„æ˜¯æä¾›ä¸°å¯Œçš„ä¿¡æ¯å’Œæ˜ç¡®çš„å«ä¹‰ã€‚

### \_\_str\_\_

> ç›¸å…³ç¬”è®°:ã€str.mdã€

ğŸ”¨ object.\_\_str\_\_(*self*)

è¯¥æ–¹æ³•ç”± [`str(object)`](https://docs.python.org/3.7/library/stdtypes.html#str) å’Œå†…ç½®å‡½æ•° [`format()`](https://docs.python.org/3.7/library/functions.html#format)ã€[`print()`](https://docs.python.org/3.7/library/functions.html#print) è°ƒç”¨ï¼Œå…¶è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡â€”â€”è¯¥å­—ç¬¦ä¸²ä¼šä»¥é€‚äºæ‰“å°çš„ã€æˆ–éæ­£å¼(*informal*)ã€å½¢å¼æ¥æè¿° *object*ã€‚

 `__str__()` å’Œ [`object.__repr__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__repr__) çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬ä¸ä¼šæœŸæœ› `__str__()` èƒ½å¤Ÿè¿”å›æœ‰æ•ˆçš„ Python è¡¨è¾¾å¼ï¼Œ`__str__()` ä¼šé‡‡ç”¨æ›´æ°å½“(æˆ–ç®€æ´)çš„æ–¹å¼æ¥æè¿°ç›®æ ‡å¯¹è±¡ã€‚

åœ¨é»˜è®¤å®ç°ä¸­ä¼šé€šè¿‡ [`object`](https://docs.python.org/3.7/library/functions.html#object) è°ƒç”¨ [`object.__repr__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__repr__)ã€‚

### \_\_bytes\_\_

> ç›¸å…³ç¬”è®°:ã€bytes.mdã€

object.`__bytes__`(*self*)

è¯¥æ–¹æ³•ç”±å†…ç½®å‡½æ•° [bytes](https://docs.python.org/3.7/library/functions.html#func-bytes) è°ƒç”¨ï¼Œç”¨äºè®¡ç®—å¯¹è±¡çš„ byte-string å½¢å¼ï¼Œå…¶è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ª [`bytes`](https://docs.python.org/3.7/library/stdtypes.html#bytes) å¯¹è±¡ã€‚

### \_\_format\_\_

> ç›¸å…³ç¬”è®°:ã€format.mdã€ã€ã€string â€” Common string operations.mdã€

ğŸ”¨ object.\_\_format\_\_(*self*, *format_spec*)

è¯¥æ–¹æ³•ç”±å†…ç½®å‡½æ•° `format()` è°ƒç”¨ï¼Œåœ¨ [f-string](https://docs.python.org/3.7/reference/lexical_analysis.html#f-strings) å’Œ [`str.format()`](https://docs.python.org/3.7/library/stdtypes.html#str.format) ä¸­éƒ½ä¼šä½¿ç”¨ `format()` æ¥å®Œæˆå¯¹è±¡çš„æ ¼å¼åŒ–æ“ä½œã€‚ä»ç»†èŠ‚ä¸Šæ¥è®²ï¼Œ`format(value, format_spec)` ä¼šåœ¨å†…éƒ¨è°ƒç”¨ `type(value).__format__(value, format_spec)`ï¼Œä»è€Œåˆ©ç”¨ç±»å­—å…¸ä¸­çš„ `__format__()` æ–¹æ³•å¯¹ `value` è¿›è¡Œæ ¼å¼åŒ–ã€‚æˆ‘ä»¬å¯åœ¨ç±»ä¸­è¦†å†™ `__format__()` æ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°è‡ªå®šä¹‰æ ¼å¼åŒ–çš„ç›®çš„ã€‚

æ³¨æ„ï¼š`__format__()` æ–¹æ³•çš„è¿”å›å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¦åˆ™ `format()` æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

*format_spec* å‚æ•°æ˜¯ç”±"æ ¼å¼åŒ–é€‰é¡¹"ç»„æˆçš„å­—ç¬¦ä¸²ã€‚*format_spec* çš„å«ä¹‰å–å†³äº `type(value).__format__` çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯å¤§å¤šæ•°ç±»éƒ½ä¼šå°†æ ¼å¼åŒ–è¿‡ç¨‹å§”æ‰˜ç»™æŸä¸ªå†…ç½®ç±»å‹ï¼Œæˆ–æ˜¯ä½¿ç”¨ä¸ [Format Specification Mini-Language](https://docs.python.org/3.7/library/string.html#formatspec) ç±»ä¼¼çš„è¯­æ³•ã€‚

æœ‰å…³æ ‡å‡†æ ¼å¼åŒ–è¯­æ³•çš„è¯´æ˜ï¼Œè¯·é˜…è¯» [Format Specification Mini-Language ](https://docs.python.org/3.7/library/string.html#formatspec)ï¼Œå¤§å¤šæ•°å†…ç½®ç±»å‹éƒ½éµå¾ªè¯¥è¯­æ³•ã€‚å› æ­¤ï¼Œå¯¹äºå†…ç½®ç±»å‹è€Œè¨€ï¼Œä¼ é€’ç»™ *format_spec* çš„å®å‚å€¼éœ€å®‰è£…å¦‚ä¸‹æ ¼å¼ç¼–å†™ï¼š(è¯¦è§ç¬”è®°ã€string â€” Common string operations.mdã€-> "Format Specification Mini-Language")

```
format_spec     ::=  [[fill]align][sign][#][0][width][grouping_option][.precision][type]
fill            ::=  <any character>
align           ::=  "<" | ">" | "=" | "^"
sign            ::=  "+" | "-" | " "
width           ::=  digit+
grouping_option ::=  "_" | ","
precision       ::=  digit+
type            ::=  "b" | "c" | "d" | "e" | "E" | "f" | "F" | "g" | "G" | "n" | "o" | "s" | "x" | "X" | "%"
```

ç¤ºä¾‹ - å±•ç¤º `format()` å’Œ `__format__()`ï¼š

```python
>>> format(97,'c') # å°†æ•´æ•°è½¬æ¢ä¸ºå¯¹åº”çš„Unicodeå­—ç¬¦
'a'
>>> type(10).__format__(10,'x')
'a'
```

**Changed in version 3.4**: The `__format__` method of `object` itself raises a [`TypeError`](https://docs.python.org/3.7/library/exceptions.html#TypeError) if passed any non-empty string.

```python
>>> object().__format__('s')
Traceback (most recent call last):
  File "<pyshell#5>", line 1, in <module>
    object().__format__('s')
TypeError: unsupported format string passed to object.__format__
```

**Changed in version 3.7**: `object.__format__(x, '')` is now equivalent to `str(x)` rather than `format(str(self), '')`.

### å¯Œæ¯”è¾ƒæ–¹æ³•

> ç›¸å…³ç¬”è®°:ã€è¡¨è¾¾å¼å’Œè¿ç®—ç¬¦.mdã€

Python æä¾›ä»¥ä¸‹å¯Œæ¯”è¾ƒæ–¹æ³•ï¼ˆ[rich comparison](https://docs.python.org/3/reference/datamodel.html#object.__lt__)ï¼‰ï¼š

- object.`__lt__`(*self*, *other*) - lessÂ thanï¼Œ`x<y` ä¼šè°ƒç”¨ `x.__lt__(y)` 
- object.`__le__`(*self*, *other*) - less equalï¼Œ`x<=y` ä¼šè°ƒç”¨ `x.__le__(y)`
- object.`__eq__`(*self*, *other*) - equal ï¼Œ`x==y` ä¼šè°ƒç”¨ `x.__eq__(y)`
- object.`__ne__`(*self*, *other*) - not equalï¼Œ`x!=y` ä¼šè°ƒç”¨ `x.__ne__(y)` 
- object.`__gt__`(*self*, *other*) - greaterÂ thanï¼Œ`x>y` ä¼šè°ƒç”¨ `x.__gt__(y)`
- object.`__ge__`(*self*, *other*) - greater equalï¼Œ`x>=y` ä¼šè°ƒç”¨ `x.__ge__(y)`

### \_\_cmp\_\_()

åœ¨ Python 3 ä¸­å·²åºŸå¼ƒï¼Œå¯å‚è€ƒï¼š[Ordering Comparisons](https://docs.python.org/3/whatsnew/3.0.html?highlight=__cmp__#ordering-comparisons) -- Whatâ€™s New In Python 3.0

### \_\_bool\_\_

> ç›¸å…³ç¬”è®°:ã€bool.mdã€,ã€çœŸå€¼æµ‹è¯•.mdã€

ğŸ”¨ object.`__bool__`(*self*)

è¯¥æ–¹æ³•ç”¨äºå®ç°çœŸå€¼æµ‹è¯•å’Œå†…ç½®æ“ä½œ `bool()`ï¼Œå…¶è¿”å›å€¼åº”æ˜¯ `False` æˆ– `True`ã€‚

```python
class Cls():
    # ä¼˜å…ˆä½¿ç”¨__bool___
    def __bool__(self):
        return True
bool(Cls()) #> True
```

å¦‚æœå¯¹è±¡ä¸­æ²¡æœ‰å®šä¹‰ `__bool__` æ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨ [`__len__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__len__) æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œå¦‚æœ `__len__()` çš„è¿”å›å€¼éé›¶ï¼Œåˆ™è®¤ä¸ºå¯¹è±¡ä¸ºçœŸã€‚

```python
class Cls():
    def __len__(self):
        return 0
bool(Cls()) #> False
```

å¦‚æœç±»å®šä¹‰ä¸­ä¸åŒ…å« [`__len__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__len__) å’Œ [`__bool__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__bool__)ï¼Œåˆ™è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹å‡ä¸ºçœŸã€‚

```python
class Cls():pass
bool(Cls())#> True
```

## [3.3.6. Emulating callable objects](https://docs.python.org/3.7/reference/datamodel.html#emulating-callable-objects)

æ¨¡æ‹Ÿå¯è°ƒç”¨å¯¹è±¡[ç‰ˆæœ¬ï¼š3.7]

### \_\_call\_\_

> ç›¸å…³ç¬”è®°: ã€callable.mdã€

ğŸ”¨ object.\_\_call\_\_(*self*[, *args*...])

å½“æˆ‘ä»¬åƒè°ƒç”¨å‡½æ•°ä¸€æ ·è°ƒç”¨ç±»å®ä¾‹æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚å¦‚æœç±»ä¸­å®šä¹‰äº†è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ç±»å®ä¾‹ x æ—¶ï¼š`x(arg1,arg2, ...)` ä¸  `x.__call__(arg1, arg2, ...)` ç­‰æ•ˆæœã€‚

ç”±äºç±»æœ¬èº«ä¹Ÿæ˜¯å¯è°ƒç”¨å¯¹è±¡(å½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªç±»æ—¶ï¼Œä¾¿ä¼šè¿”å›è¯¥ç±»çš„å®ä¾‹)ï¼Œæ‰€ä»¥ä½œä¸ºç±»å¯¹è±¡æ¨¡æ¿çš„å…ƒç±»(å¦‚ type)ä¹Ÿéœ€è¦å®ç° `__call__` æ–¹æ³•ã€‚

```python
class C(object):
    def __init__(self, sn):
        self.sn = sn

    def __call__(self):
        print(self.sn)
c = C('j35')
c() #> j35
```

`__call__()` æ–¹æ³•ä½¿å®ä¾‹å¯¹è±¡èƒ½å¤Ÿåƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ã€‚å› æ­¤ï¼Œå®Œå…¨å¯ä»¥æŠŠå®ä¾‹å¯¹è±¡çœ‹ä½œå‡½æ•°å¯¹è±¡ï¼Œæˆ–æ˜¯æŠŠå‡½æ•°å¯¹è±¡çœ‹ä½œå®ä¾‹å¯¹è±¡ã€‚
å¦‚æœæŠŠå®ä¾‹å¯¹è±¡çœ‹ä½œå‡½æ•°å¯¹è±¡ï¼Œç”±äºå®ä¾‹éƒ½æ˜¯åœ¨è¿è¡ŒæœŸé—´è¢«åˆ›å»ºå‡ºæ¥çš„ï¼Œå› æ­¤å‡½æ•°å¯¹è±¡ä¹Ÿå¯ä»¥åœ¨è¿è¡ŒæœŸé—´è¢«åŠ¨æ€åˆ›å»ºå‡ºæ¥ã€‚è¿™æ ·æ¥çœ‹ï¼Œå®ä¾‹å¯¹è±¡å’Œå‡½æ•°å¯¹è±¡é—´æ²¡æœ‰æœ¬è´¨åŒºåˆ«ã€‚

## [3.3.7. Emulating container types](https://docs.python.org/3.7/reference/datamodel.html#emulating-container-types)

ç‰ˆæœ¬ï¼š3.7

é€šè¿‡å®šä¹‰æœ¬èŠ‚ä¸­è®²è¿°çš„æ–¹æ³•ï¼Œä¾¿å¯å®ç°å®¹å™¨(container)å¯¹è±¡ã€‚
å®¹å™¨é€šå¸¸æ˜¯æŒ‡åºåˆ—(å¦‚ï¼Œåˆ—è¡¨æˆ–å…ƒç»„)æˆ–æ˜ å°„(å¦‚ï¼Œå­—å…¸)ï¼Œä½†ä¹Ÿå¯ä»¥è¡¨ç¤ºå…¶å®ƒå®¹å™¨ç±»å‹ã€‚
ç¬¬ä¸€ç»„æ–¹æ³•ç”¨äºæ¨¡æ‹Ÿåºåˆ—æˆ–æ˜ å°„ï¼›å¯¹äºåºåˆ—æ¥è¯´ï¼Œæ–¹æ³•ç­¾åä¸­å‚æ•° key çš„èŒƒå›´æ˜¯Â `0Â <=Â keyÂ <Â N`Â (N è¡¨ç¤ºåºåˆ—çš„é•¿åº¦)ï¼Œkey è¿˜å¯ä»¥æ˜¯åˆ‡ç‰‡å¯¹è±¡ã€‚

å»ºè®®åœ¨æ˜ å°„ä¸­æä¾›å¦‚ä¸‹æ–¹æ³•ï¼Œå¹¶è®©å…¶è¡Œä¸ºç±»ä¼¼äº"æ ‡å‡†å­—å…¸å¯¹è±¡"ä¸­çš„åŒåæ–¹æ³•ï¼š`keys()`,Â `values()`,Â `items()`,Â `get()`,Â `clear()`,Â `setdefault()`,Â `pop()`,Â `popitem()`,Â `copy()`, å’ŒÂ `update()` ã€‚Â [`collections.abc`](https://docs.python.org/3.7/library/collections.abc.html#module-collections.abc) æ¨¡å—æä¾›äº† Â [`MutableMapping`](https://docs.python.org/3.7/library/collections.abc.html#collections.abc.MutableMapping) æŠ½è±¡åŸºç±»ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºæ–°ç±»æ—¶å¯ä»åŸºç±»ç»§æ‰¿å¦‚ä¸‹æ–¹æ³•ï¼š [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__),Â [`__setitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__setitem__),Â [`__delitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__delitem__), andÂ `keys()`ã€‚

å¯å˜åºåˆ—åº”æä¾›å¦‚ä¸‹æ–¹æ³•ï¼Œå¹¶è®©å…¶è¡Œä¸ºç±»ä¼¼äº"æ ‡å‡†åˆ—è¡¨å¯¹è±¡"ä¸­çš„åŒåæ–¹æ³•ï¼š`append()`,Â `count()`,Â `index()`,Â `extend()`,Â `insert()`,Â `pop()`,Â `remove()`,`reverse()`Â å’ŒÂ `sort()`ã€‚
åºåˆ—ç±»å‹å¯é€šè¿‡å®šä¹‰å¦‚ä¸‹æ–¹æ³•ï¼Œæ¥å®ç°åŠ æ³•(ç”¨äºè¿æ¥ä¸¤ä¸ªåºåˆ—)å’Œä¹˜æ³•(å°†åºåˆ—æœ¬èº«è¿›è¡Œé‡å¤)ï¼šÂ [`__add__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__add__),Â [`__radd__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__radd__),Â [`__iadd__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iadd__),Â [`__mul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__mul__),Â [`__rmul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__rmul__)Â and[`__imul__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__imul__)Â â€”â€” é™¤æ­¤ä¹‹å¤–ä¸è¦å®šä¹‰å…¶å®ƒæ•°å€¼è¿ç®—ç¬¦ã€‚

å»ºè®®æ˜ å°„å’Œåºåˆ—éƒ½å®ç°Â [`__contains__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__contains__) æ–¹æ³•ï¼Œä»¥ä¾¿ä½¿ç”¨ `in` è¿›è¡Œæˆå‘˜æµ‹è¯•ï¼›å¯¹äºæ˜ å°„ï¼Œ`in` å°† key ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼›å¯¹äºåºåˆ—ï¼Œ`in` å°†å€¼ä½œä¸ºæµ‹è¯•å¯¹è±¡ã€‚è¿˜å»ºè®®åœ¨æ˜ å°„å’Œåºåˆ—ä¸­å‡å®ç°Â [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__)Â æ–¹æ³•ï¼Œä»¥ä¾¿å¯¹å®¹å™¨è¿›è¡Œè¿­ä»£ï¼›å¯¹äºæ˜ å°„ï¼Œ [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__) åº”ç±»ä¼¼äº `keys()`ï¼›å¯¹äºåºåˆ—ï¼Œè¿­ä»£æ“ä½œçš„å¯¹è±¡æ˜¯å€¼ã€‚

### \_\_len\_\_

> ç›¸å…³ç¬”è®°:ã€len.mdã€

object.`__len__`(*self*)

è¯¥å‡½æ•°åº”è¿”å›å¯¹è±¡çš„é•¿åº¦(é•¿åº¦å€¼æ˜¯ `>=0` çš„æ•´æ•°)ï¼Œå†…ç½®å‡½æ•°Â [`len()`](https://docs.python.org/3.7/library/functions.html#len) ä¼šè°ƒç”¨æ­¤å‡½æ•°æ¥è·å–é•¿åº¦å€¼ã€‚å¦å¤–ï¼Œå¯¹äºæœªå®šä¹‰Â [`__bool__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__bool__) æ–¹æ³•çš„å¯¹è±¡ï¼Œåœ¨ Boolean ä¸Šä¸‹æ–‡ä¸­ä¼šå°†Â [`__len__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__len__)Â è¿”å› 0 çš„æƒ…å½¢è§†ä¸º `False`ã€‚

```python
class Cls(object):
    def __init__(self, lst):
        self._lst = lst

    def __len__(self):
        return len(self._lst)
```

**CPython å®ç°ç»†èŠ‚ï¼š**åœ¨ CPython ä¸­ï¼Œé•¿åº¦(length)çš„æœ€å¤§å€¼ä¸èƒ½è¶…è¿‡Â [`sys.maxsize`](https://docs.python.org/3.7/library/sys.html#sys.maxsize)ã€‚å¦‚æœé•¿åº¦å¤§äº `sys.maxsize`ï¼ŒæŸäº›åŠŸèƒ½(å¦‚ `len()`)ä¾¿å¯èƒ½ä¼šå¼•å‘ [`OverflowError`](https://docs.python.org/3.7/library/exceptions.html#OverflowError)ã€‚ä¸ºäº†é¿å…è¿›è¡ŒçœŸå€¼æµ‹è¯•æ—¶æŠ›å‡ºÂ `OverflowError`ï¼Œå¯¹è±¡å¿…é¡»å®šä¹‰Â [`__bool__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__bool__)Â æ–¹æ³•ã€‚

### \_\_length_hint\_\_

### \_\_getitem\_\_

> ç›¸å…³ç¬”è®°:ã€Subscriptions & Slicings.mdã€

ğŸ”¨ object.`__getitem__`(*self*, *key*)

`__getitem__` æ–¹æ³•ç”¨äºå®ç°å¯¹ `self[key]` è¿›è¡Œæ±‚å€¼ã€‚
å¯¹äºåºåˆ—ç±»å‹ï¼Œ*key* å¯ä»¥æ˜¯æ•´æ•°æˆ–åˆ‡ç‰‡(*slice*)å¯¹è±¡ã€‚
å¦‚æœå¸Œæœ›è‡ªå®šä¹‰ç±»æ¨¡ä»¿åºåˆ—ç±»å‹ï¼Œé‚£ä¹ˆ `__getitem__()` æ–¹æ³•éœ€è¦å¯¹è´Ÿç´¢å¼•è¿›è¡Œè§£é‡Šã€‚
å¦‚æœ *key* å¹¶éåˆé€‚çš„ç±»å‹ï¼Œåˆ™å¯èƒ½ä¼šæŠ›å‡º [`TypeError`](https://docs.python.org/3.7/library/exceptions.html#TypeError)ï¼›å¦‚æœç´¢å¼•å€¼è¶…è¿‡äº†å¯ç´¢å¼•çš„èŒƒå›´(éœ€è¦è€ƒè™‘è´Ÿç´¢å¼•çš„èŒƒå›´)ï¼Œåˆ™åº”æŠ›å‡º [`IndexError`](https://docs.python.org/3.7/library/exceptions.html#IndexError)ã€‚

å¯¹äºæ˜ å°„ç±»å‹ï¼Œå¦‚æœå®¹å™¨ä¸­ä¸åŒ…å« *key*ï¼Œåˆ™åº”æŠ›å‡º [`KeyError`](https://docs.python.org/3.7/library/exceptions.html#KeyError)ã€‚

æ³¨æ„ï¼š[`for`](https://docs.python.org/3.7/reference/compound_stmts.html#for) å¾ªç¯ä¼šæœŸæœ›åœ¨è¿›è¡Œéæ³•ç´¢å¼•æ—¶æŠ›å‡º [`IndexError`](https://docs.python.org/3.7/library/exceptions.html#IndexError)ï¼Œä»è€Œèƒ½å¤Ÿæ­£ç¡®æ£€æµ‹åºåˆ—çš„ç»“å°¾ã€‚

#### a. åˆ‡ç‰‡

åªèƒ½é€šè¿‡ `__getitem__`ã€`__setitem__`ã€`__delitem__` æ¥å®Œæˆåˆ‡ç‰‡æ“ä½œã€‚

åœ¨åˆ‡ç‰‡æ—¶ï¼Œä¾‹å¦‚ `a[1:2] = b` å°†è¢«ç¿»è¯‘ä¸º `a[slice(1, 2, None)] = b` ï¼Œä¼šä½¿ç”¨ `None` å¡«å……åˆ‡ç‰‡ä¸­ç¼ºå°‘çš„é¡¹ã€‚

### \_\_setitem\_\_

> ç›¸å…³ç¬”è®°:ã€Subscriptions & Slicings.mdã€

ğŸ”¨ object.`__setitem__`(*self*, *key*, *value*)

è¯¥æ–¹æ³•ç”¨äºå®ç°å¯¹ `self[key]` è¿›è¡Œèµ‹å€¼ï¼Œå¯å‚è€ƒ `__getitem__` çš„ç”¨æ³•ã€‚

å¯¹äºæ˜ å°„ç±»å‹ï¼Œå¯é€šè¿‡ `__setitem__` å¯¹ç°æœ‰çš„ *key* é‡æ–°èµ‹å€¼ï¼Œæˆ–æ·»åŠ æ–°çš„ *key-value*  å¯¹ã€‚

å¯¹äºåºåˆ—ç±»å‹ï¼Œå¯é€šè¿‡ `__setitem__` å¯¹ç´¢å¼• *key* é‡æ–°èµ‹å€¼ã€‚

å¯¹äºé”™è¯¯çš„ *key* å€¼åº”æŠ›å‡ºä¸ [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__) ç›¸åŒçš„å¼‚å¸¸ã€‚

### \_\_delitem\_\_

> ç›¸å…³ç¬”è®°:ã€Subscriptions & Slicings.mdã€

ğŸ”¨ object.`__delitem__`(*self*, *key*)

è¯¥æ–¹æ³•ç”¨äºå®ç°åˆ é™¤ `self[key]`ï¼Œå¯å‚è€ƒ `__getitem__` çš„ç”¨æ³•ã€‚

å¯¹äºæ˜ å°„ç±»å‹ï¼Œå¯é€šè¿‡ `__delitem__` åˆ é™¤ *key*ã€‚

å¯¹äºåºåˆ—ç±»å‹ï¼Œå¯é€šè¿‡ `__delitem__` åˆ é™¤ç´¢å¼• *key* å¤„çš„å…ƒç´ ã€‚

å¯¹äºé”™è¯¯çš„ *key* å€¼åº”æŠ›å‡ºä¸ [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__) ç›¸åŒçš„å¼‚å¸¸ã€‚

### \_\_missing\_\_

> ç›¸å…³ç¬”è®°:ã€Subscriptions & Slicings.mdã€

å¯¹äº dict çš„å­ç±»ï¼Œå½“ *key* ä¸æ˜¯å­—å…¸ä¸­é”®æ—¶ï¼Œä¾¿ä¼šé€šè¿‡ [`dict`](https://docs.python.org/3.7/library/stdtypes.html#dict).[`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__) è°ƒç”¨ `__missing__` æ–¹æ³•ã€‚

```python
class SubDict(dict):
    def __missing__(self, key):
        return 'orca_j35'

x = SubDict()
x['2'] #> 'orca_j35'
```

### \_\_iter\_\_

> ç›¸å…³ç¬”è®°:ã€å®¹å™¨vs.å¯è¿­ä»£vs.è¿­ä»£å™¨vs.ç”Ÿæˆå™¨.mdã€,ã€è¿­ä»£å™¨ç±»å‹(iterator).mdã€

ğŸ”¨ object.`__iter__`(*self*)

å½“éœ€è¦å®¹å™¨æä¾›è¿­ä»£å™¨(iterator)æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œé€šè¿‡è¯¥è¿­ä»£å™¨å¯¹è±¡å¯éå†å®¹å™¨ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚å¦‚æœå®¹å™¨æœ¬èº«å°±æ˜¯è¿­ä»£å™¨ï¼Œåœ¨è°ƒç”¨è¯¥æ–¹æ³•åï¼Œä¾¿ä¼šè¿”å›å®¹å™¨è‡ªèº«ã€‚å¯¹äºæ˜ å°„å¯¹è±¡ï¼Œåº”ä½¿ç”¨é”®è¿›è¡Œè¿­ä»£ã€‚

è¿­ä»£å™¨å¯¹è±¡åŒæ ·éœ€è¦å®ç°è¯¥æ–¹æ³•ï¼Œå¹¶é€šè¿‡è¯¥æ–¹æ³•è¿”å›å…¶è‡ªèº«ã€‚æœ‰å…³è¿­ä»£å™¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·çœ‹ [Iterator Types](https://docs.python.org/3.7/library/stdtypes.html#typeiter) ã€‚

```python
class Fib(object):
    def __reset(self):
        self.a = 1
        self.b = 1

    def __init__(self):
        self.__reset()


    def __iter__(self):
        """æµ‹è¯•è¯¥æ–¹æ³•å‰ï¼Œè¯·åˆ é™¤__contains__"""
        print("è°ƒç”¨ __iter__()")
        self.__reset()
        return self

    def __next__(self):
        self.a, self.b = self.b, self.a + self.b  # è®¡ç®—ä¸‹ä¸€ä¸ªå€¼
        if self.a > 100000:  # é€€å‡ºå¾ªç¯çš„æ¡ä»¶
            print("åœæ­¢è¿­ä»£")
            raise StopIteration()
        return self.a  # è¿”å›ä¸‹ä¸€ä¸ªå€¼
```

### \_\_reversed\_\_

> ç›¸å…³ç¬”è®°:ã€reversed.mdã€

ğŸ”¨ object.`__reversed__`(*self*)

å†…ç½®å‡½æ•° [`reversed()`](https://docs.python.org/3.7/library/functions.html#reversed) ä¼šè°ƒç”¨è¯¥æ–¹æ³•(å¦‚æœå­˜åœ¨)æ¥å®ç°åå‘è¿­ä»£ã€‚`__reversed__` åº”è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šä»¥ç›¸åçš„é¡ºåºè¿­ä»£å®¹å™¨ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

å¦‚æœæ²¡æœ‰æä¾› [`__reversed__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__reversed__) æ–¹æ³•ï¼Œå†…ç½®å‡½æ•° [`reversed()`](https://docs.python.org/3.7/library/functions.html#reversed) åˆ™ä¼šä½¿ç”¨åºåˆ—åè®® ([`__len__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__len__) å’Œ [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__))ã€‚åªæœ‰å½“æ”¯æŒåºåˆ—åè®®çš„å¯¹è±¡èƒ½æä¾›æ¯” [`reversed()`](https://docs.python.org/3.7/library/functions.html#reversed) çš„åŸç”Ÿå®ç°çš„æ›´é«˜æ•ˆçš„å®ç°æ—¶ï¼Œæ‰åº”å®ç°è‡ªå·±çš„ [`__reversed__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__reversed__) æ–¹æ³•ã€‚

### \_\_contains\_\_

> ç›¸å…³ç¬”è®°:ã€è¡¨è¾¾å¼å’Œè¿ç®—ç¬¦.mdã€,ã€6. Expressions_è¡¨è¾¾å¼_æ“ä½œç¬¦.mdã€

æˆå‘˜æµ‹è¯•æ“ä½œç¬¦ ([`in`](https://docs.python.org/3.7/reference/expressions.html#in) å’Œ [`not in`](https://docs.python.org/3.7/reference/expressions.html#not-in)) å¸¸è§çš„å®ç°æ–¹å¼æ˜¯ï¼šé€šè¿‡å¯¹åºåˆ—è¿›è¡Œè¿­ä»£ï¼Œä»¥ç¡®å®šæ˜¯å¦å­˜åœ¨æŒ‡å®šé¡¹ã€‚ä½†æ˜¯ï¼Œå®¹å™¨å¯¹è±¡å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ¥æä¾›æ›´é«˜æ•ˆçš„å®ç°ï¼Œè¯¥æ–¹æ³•ä¹Ÿå¯ç”¨äºéåºåˆ—å¯¹è±¡ã€‚

ğŸ”¨ object.`__contains__`(*self*, *item*)

è¯¥æ–¹æ³•ç”¨äºå®ç°æˆå‘˜æµ‹è¯•ã€‚å¦‚æœ self ä¸­åŒ…å« itemï¼Œä¾¿ä¼šè¿”å› `True` ï¼›å¦åˆ™è¿”å› `False`ã€‚å¯¹äºæ˜ å°„å¯¹è±¡ï¼Œåº”å°†é”®ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼Œè€Œéå€¼æˆ–é”®å€¼å¯¹ã€‚å¦‚æœå¯¹è±¡ä¸­æœªå®šä¹‰ `__contains__`ï¼Œæˆå‘˜æµ‹è¯•ä¾¿ä¼šå°è¯•é€šè¿‡ [`__iter__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__iter__) æ¥è¿­ä»£å¯¹è±¡ï¼Œä»¥ç¡®å®šç›®æ ‡å€¼æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æœªå®šä¹‰ï¼Œåˆ™ä¼šé€šè¿‡æ—§å¼åºåˆ—è¿­ä»£åè®® [`__getitem__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__getitem__), æ¥ç¡®å®šç›®æ ‡æ˜¯å¦å­˜åœ¨ï¼Œè¯¦è§ [6.10.2. Membership test operations](https://docs.python.org/3.7/reference/expressions.html#membership-test-details)ã€‚

## 3.3.8. Emulating numeric types

æœ¬èŠ‚ä¸­çš„æ–¹æ³•ç”¨äºæ¨¡æ‹Ÿæ•°å€¼å¯¹è±¡ã€‚éƒ¨åˆ†ç‰¹å®šç§ç±»çš„æ•°å€¼ç±»å‹å¯èƒ½å¹¶ä¸æ”¯æŒéƒ¨åˆ†æ–¹æ³•ï¼ˆe.g., éæ•´æ•°ä¸æ”¯æŒä½æ“ä½œï¼‰ï¼Œæ­¤æ—¶åº”ä¿æŒè¿™äº›æ–¹æ³•çš„æœªå®šä¹‰çŠ¶æ€ã€‚

### äºŒå…ƒç®—æ•°è¿ç®—

```python
object.__add__(self, other) # +
object.__sub__(self, other) # -
object.__mul__(self, other) # *
object.__matmul__(self, other) # @ çŸ©é˜µä¹˜æ³•ï¼Œæ— å†…ç½®ç±»å‹å®ç°æ­¤è¿ç®—
object.__truediv__(self, other) # /
object.__floordiv__(self, other) # //
object.__mod__(self, other) # %
object.__divmod__(self, other) # divmod()
object.__pow__(self, other[, modulo]) # pow()å’Œ**
object.__lshift__(self, other) # <<
object.__rshift__(self, other) # >>
object.__and__(self, other) # and
object.__xor__(self, other) # xor
object.__or__(self, other)  # or
```

ä»¥ä¸Šæ–¹æ³•ç”¨äºå®ç°äºŒå…ƒ(*binary*)ç®—æ•°è¿ç®—ï¼Œç¤ºä¾‹ï¼š

```python
# For instance, to evaluate the expression x+y, where x is an instance of a class that has an __add__() method, x.__add__(y) is called. 
class A:
    def __init__(self,value):
        self._value=value
    def __add__(self,other):
        return self._value + other._value
x = A(1)
y = A(2)
x+y #> 3
```

[`__divmod__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__divmod__) åº”ç­‰æ•ˆäºä½¿ç”¨ [`__floordiv__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__floordiv__) å’Œ [`__mod__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__mod__)ï¼Œä¸ [`__truediv__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__truediv__) æ— å…³ã€‚

æ³¨æ„ï¼šå¦‚æœéœ€è¦ `pow()` æ”¯æŒä¸‰å‚æ•°å½¢å¼ï¼Œåˆ™åº”ä½¿ `__pow__()` å¯æ¥å—ç¬¬ä¸‰ä¸ªå¯é€‰å‚æ•°ã€‚

å¦‚æœä¸Šè¿°æŸä¸ªæ–¹æ³•ä¸æ”¯æŒæŸäº›ç±»å‹çš„å‚æ•°ï¼Œåˆ™åº”åœ¨é‡åˆ°è¿™äº›ç±»å‹çš„å‚æ•°æ—¶è¿”å› `NotImplemented`ã€‚

### äºŒå…ƒç®—æ•°è¿ç®—(åå°„)

```python
object.__radd__(self, other) # +
object.__rsub__(self, other) # -
object.__rmul__(self, other) # *
object.__rmatmul__(self, other) # @ çŸ©é˜µä¹˜æ³•ï¼Œæ— å†…ç½®ç±»å‹å®ç°æ­¤è¿ç®—
object.__rtruediv__(self, other) # /
object.__rfloordiv__(self, other) # //
object.__rmod__(self, other) # %
object.__rdivmod__(self, other) # divmod(),å¦è§divmod.md
object.__rpow__(self, other[, modulo]) # pow()å’Œ**,å¦è§pow.md
object.__rlshift__(self, other) # <<
object.__rrshift__(self, other) # >>
object.__rand__(self, other) # and
object.__rxor__(self, other) # xor
object.__ror__(self, other)  # or
```

ä»¥ä¸Šæ–¹æ³•ç”¨äºä¸ºäºŒå…ƒ(*binary*)ç®—æ•°è¿ç®—å®ç°åå°„(äº¤æ¢)æ“ä½œã€‚åªæœ‰å½“å·¦æ“ä½œæ•°"ä¸æ”¯æŒ"ç›¸åº”æ“ä½œï¼Œå¹¶ä¸”æ“ä½œæ•°æ˜¯"ä¸åŒç±»å‹"æ—¶ï¼Œæ‰ä¼šè°ƒç”¨åå°„æ–¹æ³•ã€‚

æ³¨æ„ï¼šä»¥ä¸‰å‚æ•°å½¢å¼è°ƒç”¨ `pow()` æ—¶ï¼Œä¸ä¼šå°è¯•è°ƒç”¨ `__rpow__()`ã€‚

"ä¸æ”¯æŒ"çš„æ„æ€æ˜¯ç±»ä¸­ä¸åŒ…å«ç›¸åº”æ–¹æ³•ï¼Œæˆ–è™½å®ç°äº†ç›¸åº”æ–¹æ³•ä½†è¿”å›å€¼æ˜¯ `NotImplemented`ã€‚

```python
# For instance, to evaluate the expression x - y, where y is an instance of a class that has an __rsub__() method, y.__rsub__(x) is called if x.__sub__(y) returns NotImplemented.
class X:
    def __sub__(self,other):
        return NotImplemented
class Y:
    def __rsub__(self,other):
        return 'in Y'    
    
X()-Y() # 'in Y'
```

å¦‚æœéœ€è¦å¼ºåˆ¶å›é€€è‡³å³æ“ä½œæ•°çš„åå°„æ–¹æ³•ï¼Œåˆ™ä¸åº”å°†å·¦æ“ä½œæ•°çš„æ–¹æ³•è®¾ç½®ä¸º `None`ã€‚`None` ä¼šæ˜¾ç¤ºé˜»æ­¢å›é€€æ“ä½œï¼Œå¹¶å°† `None` ç›´æ¥ç”¨ä½œè¿”å›å€¼ã€‚

```python
class A:
    def __pow__(self,other):
        return None
class B:
    def __pow__(self,other):
        return 'in B'
print(pow(A(),B())) #> None
```

å¯¹äºç›¸åŒç±»å‹çš„æ“ä½œæ•°ï¼Œå¦‚æœéåå°„æ–¹æ³•å¤±æ•ˆ(ä¾‹å¦‚ï¼Œ [`__add__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__add__))ï¼Œåˆ™è®¤ä¸ºæ“ä½œæ•°ä¸æ”¯æŒç›¸åº”çš„æ“ä½œï¼Œå¹¶ä¸ä¼šè°ƒç”¨åå°„æ–¹æ³•ã€‚

```python
class A:
    def __pow__(self,other):
        return NotImplemented
    def __rpow__(self,other):
        return 'in rpow'
pow(A(),A()) 
#> TypeError: unsupported operand type(s) for ** or pow(): 'A' and 'A'
```

æ³¨æ„ï¼šå¦‚æœå³æ“ä½œæ•°çš„ç±»å‹æ˜¯å·¦æ“ä½œæ•°çš„ç±»å‹çš„å­ç±»ï¼Œå¹¶ä¸”åœ¨è¯¥å­ç±»ä¸­ä¸ºç›¸åº”æ“ä½œæä¾›äº†åå°„æ–¹æ³•ï¼Œåˆ™ä¼šåœ¨å·¦æ“ä½œæ•°çš„éåå°„æ–¹æ³•å‰è°ƒç”¨è¯¥æ–¹æ³•ã€‚æ­¤è¡Œä¸ºå…è®¸å­ç±»è¦†ç›–å…¶çˆ¶ç±»ä¸­çš„æ“ä½œï¼š

```python
class X:
    def __sub__(self,other):
        return 'in X'
    def __rsub__(self,other):
        return 'in Xr'
class Y(X):
    def __sub__(self,other):
        return 'in Y'
    def __rsub__(self,other):
        return 'in Yr'    
    
X() - Y() #> 'in Yr'
```

### å¢é‡èµ‹å€¼

```python
object.__iadd__(self, other) # +=
object.__isub__(self, other) # -=
object.__imul__(self, other) # *=
object.__imatmul__(self, other) # @=
object.__itruediv__(self, other) # /=
object.__ifloordiv__(self, other) # //=
object.__imod__(self, other) # %=
object.__ipow__(self, other[, modulo]) # **=
object.__ilshift__(self, other) # <<=
object.__irshift__(self, other) # >>=
object.__iand__(self, other) # &=
object.__ixor__(self, other) # ^=
object.__ior__(self, other) # |=
```

ä»¥ä¸Šæ–¹æ³•ç”¨äºå®ç°å¢é‡ç®—æœ¯èµ‹å€¼ã€‚è¿™äº›æ–¹æ³•åº”å°è¯•å°±åœ°(*in-place*)æ‰§è¡Œæ“ä½œï¼ˆä¿®æ”¹ *slef* ï¼‰ï¼Œå¹¶è¿”å›ç»“æœï¼ˆå¯èƒ½æ˜¯ï¼Œä½†ä¸ä¸€å®šæ˜¯ *self* ï¼‰ã€‚

```python
class A:
    def __init__(self,value):
        self._value = value
    def __iadd__(self,other):
        self._value += other
        return self
x = A(1)
x += 1 # ä¼šå°†x.__iadd__çš„è¿”å›å€¼èµ‹ç»™x
x._value #> 2
```

å¦‚æœæœªå®šä¹‰å¢é‡èµ‹å€¼æ–¹æ³•ï¼Œåˆ™ä¼šå›é€€è‡³å¸¸è§„æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œå¦‚æœ *x* æ˜¯å®ç°äº† `__iadd__()` æ–¹æ³•çš„ç±»çš„å®ä¾‹ï¼Œé‚£ä¹ˆ `x += y` ç­‰æ•ˆäº `x = x.__iadd__(y)`ã€‚å¦åˆ™ï¼Œä¼šè€ƒè™‘ä½¿ç”¨ `x.__add__(y)` å’Œ `y.__radd__(x)` æ¥å¯¹ `x + y` è¿›è¡Œæ±‚å€¼ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¢å¼ºèµ‹å€¼å¯èƒ½ä¼šå¯¼è‡´æ„å¤–é”™è¯¯ï¼ˆè¯¦è§ [Why does a_tuple[i\] += [â€˜itemâ€™] raise an exception when the addition works?](https://docs.python.org/3.7/faq/programming.html#faq-augmented-assignment-tuple-error)ï¼‰ï¼Œä½†è¿™ç§è¡Œä¸ºå®é™…ä¸Šæ˜¯æ•°æ®æ¨¡å‹çš„ä¸€éƒ¨åˆ†ã€‚

### ä¸€å…ƒç®—æ•°è¿ç®—

```python
object.__neg__(self) # 
object.__pos__(self) # 
object.__abs__(self) # 
object.__invert__(self) # ~
```

ä»¥ä¸Šæ–¹æ³•ç”¨äºå®ç°ä¸€å…ƒç®—æ•°è¿ç®—ç¬¦ã€‚

### complex, int, float

```python
object.__complex__(self)
object.__int__(self)
object.__float__(self)
```

ä»¥ä¸Šä¸‰ä¸ªç‰¹æ®Šæ–¹æ³•åˆ†åˆ«ç”¨äºå®ç°å†…ç½®å‡½æ•° [`complex()`](https://docs.python.org/3.7/library/functions.html#complex)ã€[`int()`](https://docs.python.org/3.7/library/functions.html#int) å’Œ [`float()`](https://docs.python.org/3.7/library/functions.html#float)ã€‚å®ƒä»¬åº”è¿”å›é€‚å½“ç±»å‹çš„å€¼ã€‚

### \_\_index\_\_

object.`__index__`(*self*)

ç”¨äºå®ç° [`operator.index()`](https://docs.python.org/3.7/library/operator.html#operator.index)ï¼Œæ¯å½“ Python éœ€è¦å°†æŸä¸ªæ•°å€¼(*numeric*)å¯¹è±¡æ— æŸçš„è½¬æ¢ä¸ºæ•´æ•°å¯¹è±¡æ—¶(ä¾‹å¦‚ï¼Œåˆ‡ç‰‡æˆ–å†…ç½®å‡½æ•° `bin()` / `hex()` / `oct`)ï¼Œä¾¿ç”¨è°ƒç”¨è¯¥ç‰¹æ®Šæ–¹æ³•ã€‚å¦‚æœå­˜åœ¨æ­¤æ–¹æ³•ï¼Œåˆ™è¡¨æ˜è¯¥æ•°å€¼å¯¹è±¡æ˜¯æ•´æ•°ç±»å‹ã€‚è¯¥æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªæ•´æ•°ã€‚

Note: In order to have a coherent integer type class, when [`__index__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__index__) is defined [`__int__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__int__) should also be defined, and both should return the same value.

æœ‰å…³ [`__index__()`](https://docs.python.org/3/reference/datamodel.html#object.__index__) å’Œ `__int__` çš„åŒºåˆ«ï¼Œå¯é˜…è¯»ï¼š

- [PEP 357: The â€˜`__index__`â€™ method](https://docs.python.org/3/whatsnew/2.5.html#pep-357-the-index-method)
- [PEP 357 -- Allowing Any Object to be Used for Slicing](

object.`__abs__`(*self*) - è¯¦è§ç¬”è®°ã€abc.mdã€

### round, trunc, floor, ceil

```python
object.__round__(self[, ndigits]) # å®ç°round
object.__trunc__(self) # å®ç°math.truct
object.__floor__(self) # å®ç°math.floor
object.__ceil__(self) # å®ç°math.ceil
```

ä»¥ä¸Šå‡½æ•°ç”¨äºå®ç° [`round()`](https://docs.python.org/3.7/library/functions.html#round), [`math.trunc()`](https://docs.python.org/3.7/library/math.html#math.trunc), [`math.floor()`](https://docs.python.org/3.7/library/math.html#math.floor), [`math.ceil()`](https://docs.python.org/3.7/library/math.html#math.ceil)ã€‚

é™¤äº† `__round__()` çš„åŒå‚æ•°å½¢å¼ï¼Œæ‰€æœ‰æ–¹æ³•å‡ä¼šå°†å¯¹è±¡çš„è¿”å›å€¼æˆªæ–­ä¸º [`Integral`](https://docs.python.org/3.7/library/numbers.html#numbers.Integral) (é€šå¸¸æ˜¯ [`int`](https://docs.python.org/3.7/library/functions.html#int))ã€‚

```python
import math
math.trunc(1.2),math.floor(1.6),math.ceil(1.1)
#> (1, 1, 2)
```

å¦‚æœæœªå®šä¹‰ [`__int__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__int__)ï¼Œé‚£ä¹ˆ [`int()`](https://docs.python.org/3.7/library/functions.html#int) å°†å›é€€åˆ° [`__trunc__()`](https://docs.python.org/3.7/reference/datamodel.html#object.__trunc__)ã€‚